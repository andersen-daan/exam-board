<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®šæœŸè©•é‡æ•¸ä½çœ‹æ¿</title>
    <style>
        :root {
            --bg-color: #EEF2E6; 
            --card-bg: #FFFFFF;
            --primary-color: #6B8E88; 
            --text-main: #2C3E50; 
            --text-light: #B0B0B0;
            --danger-color: #E07A5F; 
            --clock-color: #2F3E46;
            --warning-yellow: #F4D35E; 
            --sync-on: #27ae60; 
            --sync-off: #c0392b; 
            --view-student: #3498db; 
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 15px; padding-bottom: 25px; 
            color: var(--text-main);
            height: 100vh; height: 100dvh; width: 100vw;
            display: flex; flex-direction: column; overflow: hidden; 
            position: fixed; top: 0; left: 0;
        }

        /* ç™»å…¥é®ç½© */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(238, 242, 230, 0.98);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 6000; transition: opacity 0.5s;
        }
        #loginOverlay.hidden { opacity: 0; pointer-events: none; }
        
        /* é©—è­‰è¦–çª— & æ¨¡å¼é¸æ“‡è¦–çª— (å…±ç”¨æ¨£å¼) */
        #authModal, #modeSelectionModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 7000; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; padding: 25px; border-radius: 12px; text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); width: 320px;
            animation: popIn 0.3s ease;
        }
        .modal-box h3 { margin-top: 0; color: var(--primary-color); margin-bottom: 15px;}
        .auth-timer { font-size: 0.9rem; color: var(--danger-color); margin-bottom: 10px; }
        
        /* æ¨¡å¼é¸æ“‡æŒ‰éˆ•ç¾¤ */
        .mode-btn-group { display: flex; flex-direction: column; gap: 10px; }
        .btn-mode-select { 
            padding: 12px; font-size: 1.1rem; border: 1px solid #ddd; border-radius: 8px; 
            background: #f8f9fa; cursor: pointer; transition: background 0.2s;
        }
        .btn-mode-select:hover { background: #e2e6ea; }
        .btn-mode-select.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* å­¸ç”Ÿé€šçŸ¥é®ç½© */
        #studentOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; pointer-events: none;
            opacity: 0; transition: opacity 0.3s;
        }
        #studentOverlay.active { opacity: 1; }

        .overlay-message {
            width: 100%; display: flex; justify-content: center; align-items: center; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            pointer-events: auto;
            background: var(--warning-yellow); color: #000; 
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .overlay-message h1 { font-size: clamp(2rem, 5vw, 4rem); margin: 0; font-weight: 900; line-height: 1.3; }

        .h-33 { height: 33vh; }
        .h-50 { height: 50vh; }
        .blink-effect { animation: blink-text 0.8s infinite; }

        .login-box input, .modal-box input {
            padding: 10px; font-size: 20px; text-align: center;
            border: 2px solid var(--primary-color); border-radius: 8px;
            outline: none; width: 100%; letter-spacing: 2px; margin-bottom: 15px;
        }
        .login-btn {
            margin-top: 10px; padding: 10px 30px; font-size: 18px;
            background: var(--primary-color); color: white; border: none;
            border-radius: 8px; cursor: pointer;
        }

        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; background: var(--card-bg);
            border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 8px; flex-shrink: 0; height: 50px;
            z-index: 3000; position: relative;
        }
        h1 { margin: 0; font-size: 1.6rem; color: var(--primary-color); letter-spacing: 2px; line-height: 50px; }
        .controls { display: flex; gap: 8px; align-items: center; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; background: #eee; color: #666; }
        #syncStatus { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; margin-right: 5px; }
        #syncStatus.active { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        #mainContainer {
            display: flex; flex-direction: row; gap: 12px; flex: 1; min-height: 0; 
            margin-bottom: 15px; overflow: hidden;
        }
        .left-column, .right-column {
            display: flex; flex-direction: column; gap: 12px; 
            height: 100%; overflow: hidden;
        }

        .card {
            background: var(--card-bg); border-radius: 12px; padding: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            position: relative; display: flex; flex-direction: column; overflow: hidden; 
        }
        .card-header {
            font-size: 1.3rem; font-weight: bold; color: var(--primary-color);
            margin-bottom: 5px; border-left: 4px solid var(--primary-color);
            padding-left: 8px; display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }

        .btn { padding: 3px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
        .btn-edit { background: #eee; color: #555; }
        .btn-save { background: var(--primary-color); color: white; }
        .btn-logout { background: #e74c3c; color: white; }
        
        .btn-sync { background: var(--sync-on); color: white; min-width: 80px; }
        .btn-sync.paused { background: var(--sync-off); animation: pulse-red 2s infinite; }
        
        .btn-view { background: var(--view-student); color: white; min-width: 80px; }
        .btn-view.active { border: 2px solid #2980b9; box-shadow: inset 0 0 5px rgba(0,0,0,0.3); }

        .admin-only { display: none !important; }
        body.role-admin .admin-only { display: inline-block !important; }
        body.role-student .card-header .btn-edit { display: none !important; }

        #clockCard { 
            justify-content: center; align-items: center; text-align: center;
            flex-shrink: 0; position: relative; min-height: 120px;
        }
        #timeDisplay { font-family: 'Courier New', monospace; font-weight: bold; color: var(--clock-color); line-height: 1; white-space: nowrap; }
        #dateDisplay { font-size: 1.8rem; font-weight: bold; margin-top: 5px; color: var(--primary-color); }
        #timeDisclaimer { position: absolute; bottom: 5px; right: 10px; font-size: 1rem; color: #444; display: none; font-weight: bold; text-align: right; }

        #countdownArea { width: 100%; margin-top: 5px; display: none; }
        .progress-container { width: 100%; height: 15px; background-color: #eee; border-radius: 12px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; width: 100%; background-color: var(--danger-color); transition: width 1s linear; }
        #countdownText { font-size: 1.3rem; font-weight: bold; color: var(--danger-color); display: block; }

        #infoCard { flex: 1; min-height: 0; position: relative; }
        #announcementContent {
            white-space: pre-line; font-size: 1.3rem; line-height: 1.3; color: #444;
            overflow-y: auto; flex: 1; padding-right: 5px;
        }
        
        #hurryImageContainer {
            margin-top: 5px; display: none; justify-content: center; align-items: center; height: 40%; 
        }
        #hurryImageContainer.expanded {
            display: flex !important;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 50; 
            margin: 0; border-radius: 12px; padding: 10px;
        }
        #hurryImage { max-height: 100%; max-width: 100%; border-radius: 12px; object-fit: contain; transition: all 0.3s ease; }

        #scheduleCard { height: 100%; min-height: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 0; }
        th { text-align: left; color: #666; border-bottom: 2px solid #eee; padding: 6px; font-size: 0.9rem; position: sticky; top: 0; background: white;}
        td { padding: 8px 6px; border-bottom: 1px solid #f5f5f5; font-size: 1.05rem; color: var(--text-main); font-weight: bold;}
        tr.past-row td { color: var(--text-light); font-weight: normal; }
        tr.current-row { background-color: rgba(107, 142, 136, 0.15); border-left: 4px solid var(--primary-color); }
        tr.loading-row td { text-align: center; color: var(--text-light); padding: 20px; }

        #attendanceCard {
            height: 140px; flex-shrink: 0; 
            display: flex; flex-direction: column; justify-content: center; 
            padding: 5px 25px; background: var(--primary-color); color: white;
            position: relative; border-radius: 12px; gap: 10px; 
            z-index: 3000; 
        }
        .att-top-row { display: flex; justify-content: space-evenly; align-items: center; width: 100%; height: 50%; }
        .att-item-container { display: flex; justify-content: center; align-items: center; gap: 10px; }
        .att-label { font-size: 1.4rem; opacity: 0.95; white-space: nowrap; }
        .att-val { 
            font-size: 2.2rem; font-weight: bold; width: 70px; text-align: center;
            background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 8px;
            padding: 0px;
        }
        .att-unit { font-size: 1.1rem; margin-left: 5px; opacity: 0.8; }
        
        .att-bottom-row { display: flex; justify-content: center; align-items: center; width: 100%; height: 50%; gap: 10px; }
        .input-wrapper { display: flex; align-items: center; gap: 5px; flex: 1; max-width: 600px; }
        #absentVal { flex: 1; text-align: left; padding-left: 15px; font-size: 1.4rem; background: rgba(255,255,255,0.2); border: 2px dashed rgba(255,255,255,0.6); color: white; border-radius: 8px; height: 45px; cursor: pointer; transition: background 0.3s; }
        #absentVal:hover { background: rgba(255,255,255,0.3); }
        .signature { position: absolute; bottom: 5px; right: 10px; font-size: 0.9rem; color: rgba(255,255,255,0.8); font-weight: normal; letter-spacing: 1px; }

        #seatModal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 6000; justify-content: center; align-items: center; }
        .seat-grid-container { 
            background: white; padding: 15px; border-radius: 15px; width: 95%; max-width: 700px; 
            max-height: 95vh; display: flex; flex-direction: column; 
        }
        .seat-header { display: flex; justify-content: center; margin-bottom: 10px; color: var(--primary-color); font-size: 1.2rem; font-weight: bold; }
        .seat-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 6px; margin: 0; flex: 1; overflow-y: auto; }
        .seat-btn { aspect-ratio: 1.2; display: flex; justify-content: center; align-items: center; font-size: 1.1rem; border-radius: 6px; border: 1px solid #ddd; background: white; cursor: pointer; color: #333; }
        .seat-btn.selected { background: var(--danger-color); color: white; border-color: var(--danger-color); }
        .seat-footer { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; }
        .btn-clear { background: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; }
        .btn-confirm { background: var(--primary-color); color: white; padding: 10px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; margin-right: 10px;}
        .btn-cancel { background: #ccc; color: #333; padding: 10px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 6000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 600px; max-height: 80vh; overflow-y: auto; }
        .edit-row { display: grid; grid-template-columns: 1fr 1fr 1.5fr 1fr auto; gap: 5px; margin-bottom: 10px; }
        .edit-row input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; }

        body.mode-study .left-column { width: 50%; }
        body.mode-study .right-column { width: 50%; }
        body.mode-study #clockCard { height: auto; padding: 10px; flex-shrink: 0; }
        body.mode-study #timeDisplay { font-size: 5vw; }

        body.mode-exam .left-column { width: 50%; }
        body.mode-exam .right-column { width: 50%; }
        body.mode-exam #clockCard { flex: 1; } 
        body.mode-exam #infoCard { display: none; } 
        body.mode-exam #scheduleCard { display: none; }
        body.mode-exam #timeDisclaimer { display: block; } 
        body.mode-exam #timeDisplay { font-size: min(8.5vw, 20vh); }

        input:not(:read-only) { background: rgba(255,255,255,0.2); border: 1px dashed rgba(255,255,255,0.5); cursor: text; }
        input:read-only { cursor: default; outline: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes blink-text { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.7; box-shadow: 0 0 10px #c0392b; } 100% { opacity: 1; } }
    </style>
</head>
<body class="mode-study">

    <div id="loginOverlay">
        <h2 style="color:var(--primary-color); margin-bottom:30px;">å®šæœŸè©•é‡æ•¸ä½çœ‹æ¿ç³»çµ±</h2>
        <div class="login-box">
            <input type="password" id="passInput" placeholder="èº«ä»½é©—è­‰ç¢¼" onkeyup="if(event.key==='Enter') login()">
            <br>
            <div style="text-align: center;">
                <button class="login-btn" onclick="login()">ç™»å…¥</button>
            </div>
        </div>
    </div>

    <div id="authModal">
        <div class="modal-box auth-box">
            <h3>æ¬Šé™é©—è­‰</h3>
            <div id="authTimer" class="auth-timer">15 ç§’å¾Œé—œé–‰</div>
            <input type="password" id="authInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" onkeyup="if(event.key==='Enter') verifyAuth()">
            <div>
                <button class="btn btn-save" onclick="verifyAuth()">ç¢ºå®š</button>
                <button class="btn btn-edit" onclick="closeAuthModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="modeSelectionModal">
        <div class="modal-box">
            <h3>é¸æ“‡ç‰ˆé¢æ¨¡å¼</h3>
            <div class="mode-btn-group">
                <button class="btn-mode-select" onclick="setForceMode('AUTO')">æ¢å¾©è‡ªå‹•æ¨¡å¼ (ä¾æ™‚é–“)</button>
                <button class="btn-mode-select" onclick="setForceMode('EXAM')">å¼·åˆ¶åˆ‡æ›ï¼šè€ƒè©¦ç‰ˆé¢</button>
                <button class="btn-mode-select" onclick="setForceMode('STUDY')">å¼·åˆ¶åˆ‡æ›ï¼šè‡ªç¿’ç‰ˆé¢</button>
            </div>
            <div style="margin-top:15px;">
                <button class="btn btn-edit" onclick="closeModeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="studentOverlay">
        <div class="overlay-message" id="overlayMessage"></div>
    </div>

    <header>
        <div style="display:flex; align-items:center;">
            <h1>å®šæœŸè©•é‡æ•¸ä½çœ‹æ¿</h1>
            <span id="syncStatus" style="margin-left:15px;" title="åŒæ­¥ç‹€æ…‹ç‡ˆ"></span>
        </div>
        <div class="controls">
            <span id="currentModeBadge" class="status-badge">è¼‰å…¥ä¸­...</span>
            <button id="btnSyncToggle" class="btn btn-sync admin-only" onclick="tryAction('sync')">é€£ç·šä¸­</button>
            <button id="btnStudentView" class="btn btn-view admin-only" onclick="toggleStudentView()">ğŸ‘ï¸ å­¸ç”Ÿè¦–è§’</button>
            <button class="btn btn-edit" onclick="tryAction('forceMode')">å¼·åˆ¶åˆ‡æ›æ¨¡å¼</button>
            <button class="btn btn-logout" onclick="logout()">ç™»å‡º</button>
        </div>
    </header>

    <div id="mainContainer">
        <div class="left-column" id="colLeft">
            <div class="card" id="clockCard">
                <div id="timeDisplay">00:00</div>
                <div id="dateDisplay">--æœˆ--æ—¥ æ˜ŸæœŸ--</div>
                <div id="timeDisclaimer">ä»¥ä¸Šç¶²è·¯æ™‚é–“åƒ…ä¾›åƒè€ƒï¼Œè«‹åŒå­¸ä»æ‡‰ä¾å­¸æ ¡é˜è²ç‚ºæº–ã€‚</div>
                <div id="countdownArea">
                    <span id="countdownText">å€’æ•¸ 5 åˆ†é˜</span>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
            </div>
            
            <div class="card" id="infoCard">
                <div class="card-header">
                    å…¬å‘Šäº‹é …
                    <button class="btn btn-edit admin-only" onclick="editInfo()">âœ ç·¨è¼¯</button>
                </div>
                <div id="announcementContent">è®€å–ä¸­...</div>
                <div id="hurryImageContainer">
                    <img id="hurryImage" src="hurry.jpg" alt="å¿«å¯«å®Œäº†"> 
                </div>
            </div>
        </div>

        <div class="right-column" id="colRight">
            <div class="card" id="scheduleCard">
                <div class="card-header">
                    ä»Šæ—¥è€ƒç¨‹
                    <button class="btn btn-edit admin-only" onclick="openScheduleEditor()">âœ ç·¨è¼¯</button>
                </div>
                <table id="scheduleTable">
                    <thead><tr><th>æ™‚é–“</th><th>ç§‘ç›®</th><th>å‚™è¨»</th></tr></thead>
                    <tbody id="scheduleBody"><tr class="loading-row"><td colspan="3">è³‡æ–™è¼‰å…¥ä¸­...è«‹ç¨å€™</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card" id="attendanceCard">
        <div class="att-top-row">
            <div class="att-item-container">
                <span class="att-label">æ‡‰åˆ°</span>
                <input type="number" id="shouldVal" class="att-val" value="37" onchange="manualUpdateAttendance()">
                <span class="att-unit">äºº</span>
            </div>
            <div class="att-item-container">
                <span class="att-label">å¯¦åˆ°</span>
                <input type="number" id="actualVal" class="att-val" value="37" readonly>
                <span class="att-unit">äºº</span>
            </div>
        </div>
        
        <div class="att-bottom-row">
            <span class="att-label">ç¼ºå¸­åº§è™Ÿ</span>
            <div class="input-wrapper">
                <input type="text" id="absentVal" class="att-val" placeholder="ç„¡" readonly onclick="openSeatPicker()">
            </div>
        </div>
        <div class="signature">å¤§å®‰é«˜å·¥é™³å³ç…œè€å¸«è£½</div>
    </div>

    <div id="editorModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary-color)">ç·¨è¼¯è€ƒç¨‹</h3>
            <div id="editorRows"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn" onclick="addEditorRow()" style="background:#eee;">+ æ–°å¢ä¸€ç¯€</button>
                <button class="btn btn-save" onclick="saveScheduleFromEditor()">å„²å­˜</button>
                <button class="btn" onclick="closeEditor()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="seatModal" class="modal">
        <div class="seat-grid-container">
            <div class="seat-header">é»é¸ç¼ºå¸­åº§è™Ÿ</div>
            <div id="seatGrid" class="seat-grid"></div>
            <div class="seat-footer">
                <button class="btn-clear" onclick="clearAllSeats()">å…¨éƒ¨æ¸…é™¤</button>
                <div>
                    <button class="btn-confirm" onclick="confirmSeats()">ç¢ºå®š</button>
                    <button class="btn-cancel" onclick="closeSeatPicker()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= ã€åƒæ•¸è¨­å®šå€ã€‘ =================
        const SYSTEM_CONFIG = {
            // [è¨­å®š] Google Sheet CSV ç¶²å€
            GOOGLE_SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQACAdB7m2Bb2uYz7aIHU5TdXo5254vD0lpaKBkkyw621OEPW0hzHMdcFa5isuUDotgbFq7GRFghl9c/pub?output=csv",
            
            // [è¨­å®š] è³‡æ–™æ›´æ–°é–“éš” (æ¯«ç§’)ï¼Œé è¨­ 60000 = 60ç§’
            UPDATE_INTERVAL: 60000
        };

        const PASSWORDS = { 
            ADMIN: '1005',   // è€å¸«/ç®¡ç†è€…é©—è­‰ç¢¼
            STUDENT: '1630'  // å­¸ç”Ÿé©—è­‰ç¢¼
        };

        const ALERT_SETTINGS = {
            PRE_EXAM_SEC: 180, // [è¨­å®š] è€ƒå‰é å‚™é˜å‡ºç¾ç§’æ•¸
            BLINK_SEC: 60,     // [è¨­å®š] é å‚™é˜é–ƒçˆç§’æ•¸
            HURRY_IMG_SEC: 180,// [è¨­å®š] Hurryåœ–ç‰‡å‡ºç¾å€’æ•¸ç§’æ•¸ (åŒæ­¥é€²åº¦æ¢)
            CLEAN_DURATION: 10,// [è¨­å®š] æ‰“æƒç•«é¢æŒçºŒåˆ†é˜æ•¸
            TEXT_PRE_EXAM: '<h1>å³å°‡é–‹å§‹è€ƒè©¦<br>è«‹å„˜é€Ÿå°±åº§ï¼</h1>', 
            TEXT_CLEAN: '<h1>è«‹é–‹å§‹é€²è¡Œ<br>æ‰“æƒå·¥ä½œ</h1>',         
            TEXT_SILENCE: '<h1>è«‹ä¿æŒå®‰éœ<br>æ‰“èµ·ç²¾ç¥<br>å°ˆå¿ƒçœ‹æ›¸</h1>'
        };
        // ============================================

        let currentUserRole = null;
        let isForceMode = false;
        let isSyncPaused = false;
        let isStudentView = false; 
        let authTimerId = null;    
        let pendingAction = null;  
        let forceStatus = 'AUTO';
        
        const DEFAULT_ANNOUNCEMENT = `è€ƒè©¦æœŸé–“è«‹éµå®ˆä»¥ä¸‹è¦å®šï¼š
1. è«‹å°‡æ‰‹æ©ŸåŠæ™ºæ…§å‹ç©¿æˆ´è£ç½®é—œæ©Ÿä¸¦æ”¾ç½®æ–¼æ‰‹æ©Ÿè¢‹ã€‚
2. æ›¸åŒ…è«‹æ”¾ç½®æ–¼æ•™å®¤å‰ã€å¾Œæ–¹èµ°é“ã€‚
3. æ¡Œå­è«‹è½‰å‘ï¼ˆæŠ½å±œæœå‘è¬›æ¡Œï¼‰ã€‚
4. æ¡Œé¢åƒ…ç•™ä¸‹å¿…è¦çš„æ–‡å…·ç”¨å“ã€‚
5. è€ƒè©¦æœŸé–“è«‹å‹¿äº¤è«‡ã€‚`;

        const DEFAULT_SCHEDULE = [];

        let appData = {
            schedule: JSON.parse(JSON.stringify(DEFAULT_SCHEDULE)),
            announcement: DEFAULT_ANNOUNCEMENT,
            attendance: { should: 37, actual: 37, absent: "" }
        };

        let tempSelectedSeats = new Set();

        function init() {
            setDocHeight();
            window.addEventListener('resize', setDocHeight);

            if(SYSTEM_CONFIG.GOOGLE_SHEET_CSV_URL && SYSTEM_CONFIG.GOOGLE_SHEET_CSV_URL.length > 10) {
                fetchGoogleSheetData();
                setInterval(() => {
                    if (!isSyncPaused) fetchGoogleSheetData();
                }, SYSTEM_CONFIG.UPDATE_INTERVAL);
            } else {
                loadLocalData();
            }
            
            updateClock();
            setInterval(updateClock, 1000);
            renderUI();
            
            const savedRole = localStorage.getItem('role');
            if(savedRole) authSuccess(savedRole);
        }

        function setDocHeight() {
            document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            document.body.style.height = `calc(var(--vh, 1vh) * 100)`;
        }

        // === é©—è­‰èˆ‡æ¬Šé™ ===
        function tryAction(action) {
            // è‹¥ç‚ºè€å¸«è¦åˆ‡æ›å¼·åˆ¶æ¨¡å¼ -> ä¸éœ€é©—è­‰ï¼Œç›´æ¥é–‹é¸å–®
            if (action === 'forceMode' && currentUserRole === 'admin') {
                openModeSelection();
                return;
            }
            pendingAction = action;
            openAuthModal();
        }

        function openAuthModal() {
            const modal = document.getElementById('authModal');
            const timerDisplay = document.getElementById('authTimer');
            const input = document.getElementById('authInput');
            
            modal.style.display = 'flex';
            input.value = '';
            input.focus();
            
            let timeLeft = 15;
            timerDisplay.textContent = `${timeLeft} ç§’å¾Œé—œé–‰`;
            
            if(authTimerId) clearInterval(authTimerId);
            authTimerId = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `${timeLeft} ç§’å¾Œé—œé–‰`;
                if(timeLeft <= 0) {
                    closeAuthModal();
                }
            }, 1000);
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            if(authTimerId) clearInterval(authTimerId);
            pendingAction = null;
        }

        function verifyAuth() {
            const val = document.getElementById('authInput').value;
            let expectedPass = '';
            
            if (pendingAction === 'sync') expectedPass = PASSWORDS.ADMIN;
            else if (pendingAction === 'forceMode') expectedPass = PASSWORDS.STUDENT; 
            
            if (val === expectedPass) {
                if (pendingAction === 'sync') toggleSync();
                else if (pendingAction === 'forceMode') openModeSelection(); // [ä¿®æ”¹] é©—è­‰æˆåŠŸå¾Œé–‹é¸å–®
                closeAuthModal();
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤");
                document.getElementById('authInput').value = '';
            }
        }

        // === [æ–°å¢] æ¨¡å¼é¸æ“‡é¸å–® ===
        function openModeSelection() {
            document.getElementById('modeSelectionModal').style.display = 'flex';
        }
        function closeModeModal() {
            document.getElementById('modeSelectionModal').style.display = 'none';
        }
        function setForceMode(mode) {
            forceStatus = mode;
            closeModeModal();
            checkScheduleMode(new Date()); // ç«‹å³ç”Ÿæ•ˆ
        }

        function toggleSync() {
            isSyncPaused = !isSyncPaused;
            const btn = document.getElementById('btnSyncToggle');
            if(isSyncPaused) {
                btn.textContent = "å·²æš«åœ";
                btn.classList.add('paused');
            } else {
                btn.textContent = "é€£ç·šä¸­";
                btn.classList.remove('paused');
                fetchGoogleSheetData();
            }
        }

        // === [ä¿®æ­£] é‡ç½®å­¸ç”Ÿç‰¹æ•ˆ ===
        function resetStudentEffects() {
            document.getElementById('studentOverlay').className = '';
            const imgContainer = document.getElementById('hurryImageContainer');
            imgContainer.style.display = 'none';
            imgContainer.classList.remove('expanded');
        }

        function toggleStudentView() {
            isStudentView = !isStudentView;
            const btn = document.getElementById('btnStudentView');
            if(isStudentView) {
                btn.textContent = "é€€å‡ºæ¼”ç¤º";
                btn.classList.add('active');
            } else {
                btn.textContent = "ğŸ‘ï¸ å­¸ç”Ÿè¦–è§’";
                btn.classList.remove('active');
                resetStudentEffects(); // [ä¿®æ­£] é€€å‡ºæ™‚å¼·åˆ¶æ¸…é™¤ç‰¹æ•ˆ
            }
            const now = new Date();
            if(isStudentView) checkStudentAlerts(now); 
            checkScheduleMode(now);
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('timeDisplay').textContent = now.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' });
            document.getElementById('dateDisplay').textContent = now.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'long' });
            
            checkScheduleMode(now);
            
            if (currentUserRole === 'student' || isStudentView) {
                checkStudentAlerts(now);
            } else {
                resetStudentEffects(); // è€å¸«æ¨¡å¼ä¸‹ç¢ºä¿ä¹¾æ·¨
            }
            
            renderScheduleColor(now);
        }

        function checkStudentAlerts(now) {
            const overlay = document.getElementById('studentOverlay');
            const msgBox = document.getElementById('overlayMessage');
            let activeAlert = null; 

            // 1. æ‰“æƒ
            if(appData.schedule.length > 0) {
                const lastItem = appData.schedule[appData.schedule.length - 1];
                const [eH, eM] = lastItem.end.split(':').map(Number);
                const endTime = new Date(); endTime.setHours(eH, eM, 0);
                if(now >= endTime && now < new Date(endTime.getTime() + ALERT_SETTINGS.CLEAN_DURATION*60000)) {
                    activeAlert = { type: 'warning', text: ALERT_SETTINGS.TEXT_CLEAN, blink: false, size: 'h-50' };
                }
            }

            // 2. é å‚™é˜
            if(!activeAlert) {
                for(let item of appData.schedule) {
                    if(item.subject === 'è‡ªç¿’' || item.subject === 'åˆä¼‘') continue;
                    const [sH, sM] = item.start.split(':').map(Number);
                    const startTime = new Date(); startTime.setHours(sH, sM, 0);
                    const diffSec = (startTime - now) / 1000;

                    if(diffSec > 0 && diffSec <= ALERT_SETTINGS.PRE_EXAM_SEC) { 
                        let blink = false;
                        let size = 'h-33'; 
                        if(diffSec <= ALERT_SETTINGS.BLINK_SEC) { 
                            blink = true;
                            size = 'h-50';
                        }
                        activeAlert = { type: 'warning', text: ALERT_SETTINGS.TEXT_PRE_EXAM, blink: blink, size: size };
                        break;
                    }
                }
            }

            // 3. è‡ªç¿’æé†’
            if(!activeAlert) {
                const nowMinutes = now.getHours() * 60 + now.getMinutes();
                const isSelfStudy = appData.schedule.some(item => {
                    const [sH, sM] = item.start.split(':').map(Number);
                    const [eH, eM] = item.end.split(':').map(Number);
                    const start = sH * 60 + sM;
                    const end = eH * 60 + eM;
                    return (nowMinutes >= start && nowMinutes < end && item.subject.includes('è‡ªç¿’'));
                });

                if(isSelfStudy) {
                    const m = now.getMinutes();
                    const s = now.getSeconds();
                    if (m % 10 === 0 && s < 30) {
                        activeAlert = { type: 'warning', text: ALERT_SETTINGS.TEXT_SILENCE, blink: false, size: 'h-50' };
                    }
                }
            }

            if(activeAlert) {
                overlay.className = 'active'; 
                msgBox.innerHTML = activeAlert.text;
                msgBox.className = `overlay-message style-warning ${activeAlert.size}`;
                if(activeAlert.blink) msgBox.classList.add('blink-effect');
            } else {
                overlay.className = ''; 
            }
        }

        function checkScheduleMode(now) {
            const nowTime = now.getHours() * 60 + now.getMinutes();
            let isExamining = false;
            let currentSubject = "";
            let remainingSec = 0;

            appData.schedule.forEach((item) => {
                const [sH, sM] = item.start.split(':').map(Number);
                const [eH, eM] = item.end.split(':').map(Number);
                const startMin = sH * 60 + sM;
                const endMin = eH * 60 + eM;
                if (nowTime >= startMin && nowTime < endMin) {
                    if (item.subject !== "è‡ªç¿’" && item.subject !== "åˆä¼‘") {
                        isExamining = true;
                        currentSubject = item.subject;
                        const endDate = new Date();
                        endDate.setHours(eH, eM, 0);
                        remainingSec = (endDate - now) / 1000;
                    }
                }
            });

            const body = document.body;
            const badge = document.getElementById('currentModeBadge');
            const infoCard = document.getElementById('infoCard');
            const colLeft = document.getElementById('colLeft');
            const colRight = document.getElementById('colRight');
            const scheduleCard = document.getElementById('scheduleCard');

            let targetMode = 'mode-study';
            let badgeText = "";

            // [ä¿®æ­£] é¸å–®å¼ç‹€æ…‹åˆ¤æ–·
            if (forceStatus === 'EXAM') {
                targetMode = 'mode-exam';
                badgeText = "æ‰‹å‹•æ¨¡å¼ (å¼·åˆ¶è€ƒè©¦)";
            } else if (forceStatus === 'STUDY') {
                targetMode = 'mode-study';
                badgeText = "æ‰‹å‹•æ¨¡å¼ (å¼·åˆ¶è‡ªç¿’)";
            } else {
                // AUTO
                if (isExamining) {
                    targetMode = 'mode-exam';
                    badgeText = `è€ƒè©¦ä¸­ï¼š${currentSubject}`;
                } else {
                    targetMode = 'mode-study';
                    badgeText = "è‡ªå‹•æ¨¡å¼ (è‡ªç¿’/ä¸‹èª²)";
                }
            }
            
            badge.textContent = badgeText;
            isForceMode = (forceStatus !== 'AUTO');

            if (targetMode === 'mode-exam') {
                if(!body.classList.contains('mode-exam')) {
                    body.classList.remove('mode-study');
                    body.classList.add('mode-exam');
                    scheduleCard.style.display = 'none'; 
                    colRight.appendChild(infoCard); 
                    infoCard.style.display = 'flex'; infoCard.style.height = '100%'; 
                }
                if(isExamining) handleCountdown(remainingSec); 
            } else {
                if(!body.classList.contains('mode-study')) {
                    body.classList.remove('mode-exam');
                    body.classList.add('mode-study');
                    colLeft.appendChild(infoCard); 
                    scheduleCard.style.display = 'flex'; 
                }
                document.getElementById('countdownArea').style.display = 'none';
                const imgContainer = document.getElementById('hurryImageContainer');
                imgContainer.style.display = 'none';
                imgContainer.classList.remove('expanded');
            }
        }

        function handleCountdown(remainingSec) {
            const area = document.getElementById('countdownArea');
            const text = document.getElementById('countdownText');
            const bar = document.getElementById('progressBar');
            const imgContainer = document.getElementById('hurryImageContainer');
            
            if (remainingSec <= 300 && remainingSec > 0) {
                area.style.display = 'block';
                const mins = Math.ceil(remainingSec / 60);
                
                if (currentUserRole === 'student' || isStudentView) {
                    if (remainingSec <= ALERT_SETTINGS.HURRY_IMG_SEC) {
                        imgContainer.style.display = 'flex';
                        imgContainer.classList.add('expanded'); 
                    } else {
                        imgContainer.style.display = 'none';
                        imgContainer.classList.remove('expanded');
                    }
                } else {
                    imgContainer.style.display = 'none';
                }

                if (mins > 1) {
                    text.textContent = `å€’æ•¸ ${mins} åˆ†é˜`;
                    text.classList.remove('urgent');
                } else if (remainingSec > 10) {
                    text.textContent = `å€’æ•¸ 1 åˆ†é˜`;
                    text.classList.add('urgent');
                } else {
                    text.textContent = `æº–å‚™äº¤å·`;
                }
                
                const percent = (remainingSec / 300) * 100;
                bar.style.width = `${percent}%`;
            } else {
                area.style.display = 'none';
                imgContainer.style.display = 'none';
                imgContainer.classList.remove('expanded');
            }
        }

        function manualUpdateAttendance() {
            saveData();
            recalcActual();
        }

        function recalcActual() {
            const should = parseInt(document.getElementById('shouldVal').value) || 0;
            const absentStr = document.getElementById('absentVal').value;
            let absentCount = 0;
            if(absentStr && absentStr !== 'ç„¡') {
                absentCount = absentStr.split(',').length;
            }
            document.getElementById('actualVal').value = should - absentCount;
            appData.attendance.should = document.getElementById('shouldVal').value;
            appData.attendance.actual = document.getElementById('actualVal').value;
            localStorage.setItem('examDashboardData', JSON.stringify(appData));
        }

        function openSeatPicker() {
            const grid = document.getElementById('seatGrid');
            grid.innerHTML = '';
            tempSelectedSeats.clear();
            const currentStr = document.getElementById('absentVal').value;
            if(currentStr && currentStr !== 'ç„¡') {
                currentStr.split(',').forEach(s => tempSelectedSeats.add(parseInt(s.trim())));
            }
            for(let i=1; i<=50; i++) {
                const btn = document.createElement('div');
                btn.className = 'seat-btn';
                if(tempSelectedSeats.has(i)) btn.classList.add('selected');
                btn.textContent = i < 10 ? '0'+i : i;
                btn.onclick = () => {
                    if(tempSelectedSeats.has(i)) { tempSelectedSeats.delete(i); btn.classList.remove('selected'); } 
                    else { tempSelectedSeats.add(i); btn.classList.add('selected'); }
                };
                grid.appendChild(btn);
            }
            document.getElementById('seatModal').style.display = 'flex';
        }

        function clearAllSeats() {
            tempSelectedSeats.clear();
            document.querySelectorAll('.seat-btn').forEach(btn => btn.classList.remove('selected'));
        }

        function confirmSeats() {
            const sorted = Array.from(tempSelectedSeats).sort((a,b) => a-b);
            const str = sorted.map(n => n < 10 ? '0'+n : n).join(', ');
            document.getElementById('absentVal').value = str || '';
            recalcActual();
            closeSeatPicker();
        }

        function closeSeatPicker() {
            document.getElementById('seatModal').style.display = 'none';
        }

        function login() {
            const val = document.getElementById('passInput').value;
            if (val === PASSWORDS.ADMIN) authSuccess('admin');
            else if (val === PASSWORDS.STUDENT) authSuccess('student');
            else { alert("é©—è­‰ç¢¼éŒ¯èª¤"); document.getElementById('passInput').value = ""; }
        }

        function authSuccess(role) {
            currentUserRole = role;
            localStorage.setItem('role', role);
            document.getElementById('loginOverlay').classList.add('hidden');
            document.body.classList.remove('role-admin', 'role-student');
            document.body.classList.add(`role-${role}`);
            document.getElementById('shouldVal').removeAttribute('readonly'); 
        }

        function logout() { 
            if(currentUserRole === 'student') {
                if(!confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) return;
            }
            localStorage.removeItem('role'); location.reload(); 
        }
        
        function renderUI() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            if(appData.schedule.length === 0) {
                tbody.innerHTML = '<tr class="loading-row"><td colspan="3">ä»Šæ—¥ç„¡è€ƒç¨‹</td></tr>';
            } else {
                appData.schedule.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${item.start}-${item.end}</td><td>${item.subject}</td><td>${item.note}</td>`;
                    tbody.appendChild(tr);
                });
            }
            document.getElementById('announcementContent').textContent = appData.announcement;
            document.getElementById('shouldVal').value = appData.attendance.should;
            document.getElementById('actualVal').value = appData.attendance.actual;
            document.getElementById('absentVal').value = appData.attendance.absent;
        }

        function editInfo() {
            const newText = prompt("ç·¨è¼¯å…¬å‘Šå…§å®¹", appData.announcement);
            if(newText !== null) { appData.announcement = newText; saveData(); renderUI(); }
        }
        function openScheduleEditor() {
            const container = document.getElementById('editorRows');
            container.innerHTML = '';
            appData.schedule.forEach(item => addEditorRow(item));
            document.getElementById('editorModal').style.display = 'flex';
        }
        function addEditorRow(data = {start:'', end:'', subject:'', note:''}) {
            const div = document.createElement('div');
            div.className = 'edit-row';
            div.innerHTML = `
                <input type="time" class="e-start" value="${data.start}">
                <input type="time" class="e-end" value="${data.end}">
                <input type="text" class="e-sub" placeholder="ç§‘ç›®" value="${data.subject}">
                <input type="text" class="e-note" placeholder="å‚™è¨»" value="${data.note}">
                <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none;">âœ–</button>
            `;
            document.getElementById('editorRows').appendChild(div);
        }
        function saveScheduleFromEditor() {
            const rows = document.querySelectorAll('.edit-row');
            const newSchedule = [];
            rows.forEach(row => {
                const start = row.querySelector('.e-start').value;
                const end = row.querySelector('.e-end').value;
                const subject = row.querySelector('.e-sub').value;
                const note = row.querySelector('.e-note').value;
                if(start && end && subject) newSchedule.push({ start, end, subject, note });
            });
            newSchedule.sort((a, b) => a.start.localeCompare(b.start));
            appData.schedule = newSchedule;
            saveData();
            renderUI();
            closeEditor();
        }
        function closeEditor() { document.getElementById('editorModal').style.display = 'none'; }
        
        function saveData() {
            appData.attendance.should = document.getElementById('shouldVal').value;
            appData.attendance.actual = document.getElementById('actualVal').value;
            appData.attendance.absent = document.getElementById('absentVal').value;
            localStorage.setItem('examDashboardData', JSON.stringify(appData));
        }
        
        function loadLocalData() {
            const saved = localStorage.getItem('examDashboardData');
            if(saved) {
                const parsed = JSON.parse(saved);
                appData.attendance = parsed.attendance;
                if(appData.schedule.length === 0) {
                    appData.schedule = parsed.schedule;
                    appData.announcement = parsed.announcement;
                }
            }
            renderUI();
        }

        function fetchGoogleSheetData() {
            const urlWithNoCache = SYSTEM_CONFIG.GOOGLE_SHEET_CSV_URL + "&t=" + (Date.now() + Math.random());
            const statusLight = document.getElementById('syncStatus');
            fetch(urlWithNoCache, {cache: "no-store"})
            .then(response => response.text())
            .then(csvText => {
                if (isSyncPaused || document.getElementById('seatModal').style.display === 'flex' || document.activeElement.tagName === 'INPUT') return;

                const rows = csvText.split('\n').map(row => row.split(','));
                if(rows.length > 2) {
                    statusLight.classList.add('active'); 
                    setTimeout(() => statusLight.classList.remove('active'), 1000);

                    let headerIndex = -1;
                    for(let i=0; i<rows.length; i++) {
                        const rowStr = rows[i].join('').toLowerCase();
                        if(rowStr.includes('start') && rowStr.includes('subject')) {
                            headerIndex = i; break;
                        }
                    }
                    
                    let announcementText = "";
                    const limit = (headerIndex !== -1) ? headerIndex : 1;
                    let lines = [];
                    for(let i=0; i<limit; i++) {
                        let line = rows[i][0]
                            .replace(/^"|"$/g, '')
                            .replace(/""/g, '"')
                            .replace(/\\n/g, '\n');
                        lines.push(line.trimEnd());
                    }
                    announcementText = lines.join('\n').replace(/\n{3,}/g, '\n\n');
                    
                    if(announcementText) {
                        appData.announcement = announcementText;
                    }

                    const startIndex = (headerIndex !== -1) ? headerIndex + 1 : 2;
                    const newSchedule = [];
                    for(let i=startIndex; i<rows.length; i++) {
                        const row = rows[i];
                        let date = "", start, end, subject, note;
                        if(row[0].includes('20')) { 
                            date = row[0].trim();
                            start = row[1]; end = row[2]; subject = row[3]; note = row[4];
                        } else { 
                            start = row[0]; end = row[1]; subject = row[2]; note = row[3];
                        }

                        if(start && end && subject) {
                            let formattedDate = date;
                            if(date.includes('/')) {
                                const parts = date.split('/');
                                if(parts.length === 3) {
                                    const y = parts[0];
                                    const m = parts[1].padStart(2, '0');
                                    const d = parts[2].padStart(2, '0');
                                    formattedDate = `${y}/${m}/${d}`;
                                }
                            }

                            newSchedule.push({
                                date: formattedDate,
                                start: start.trim().replace(/"/g,''),
                                end: end.trim().replace(/"/g,''),
                                subject: subject.trim().replace(/"/g,''),
                                note: note ? note.trim().replace(/"/g,'') : ""
                            });
                        }
                    }

                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    const todayStr = `${yyyy}/${mm}/${dd}`;

                    let todaySchedules = newSchedule.filter(s => s.date === todayStr);
                    
                    if(todaySchedules.length > 0) {
                        appData.schedule = todaySchedules;
                    } else {
                        if(newSchedule.length > 0) {
                            const firstDate = newSchedule[0].date;
                            appData.schedule = newSchedule.filter(s => s.date === firstDate);
                        } else {
                            appData.schedule = [];
                        }
                    }
                    
                    renderUI();
                }
            })
            .catch(err => console.error("åŒæ­¥å¤±æ•—:", err));
        }

        function renderScheduleColor(now) {
            const rows = document.querySelectorAll('#scheduleBody tr');
            if(rows.length > 0 && rows[0].classList.contains('loading-row')) return;

            const nowTime = now.getHours() * 60 + now.getMinutes();
            appData.schedule.forEach((item, index) => {
                if(!rows[index]) return;
                const [eH, eM] = item.end.split(':').map(Number);
                const [sH, sM] = item.start.split(':').map(Number);
                const endMin = eH * 60 + eM;
                const startMin = sH * 60 + sM;
                rows[index].className = ''; 
                if (nowTime >= endMin) rows[index].classList.add('past-row'); 
                else if (nowTime >= startMin && nowTime < endMin) rows[index].classList.add('current-row');
            });
        }

        init();
    </script>
</body>
</html>
