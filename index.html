<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定期評量數位看板</title>
    <style>
        :root {
            --bg-color: #EEF2E6; 
            --card-bg: #FFFFFF;
            --primary-color: #6B8E88; 
            --text-main: #2C3E50; 
            --text-light: #B0B0B0;
            --danger-color: #E07A5F; 
            --clock-color: #2F3E46;
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 15px;
            color: var(--text-main);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* 登入遮罩 */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(238, 242, 230, 0.98);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 0.5s;
        }
        #loginOverlay.hidden { opacity: 0; pointer-events: none; }
        
        .login-box input {
            padding: 15px; font-size: 28px; text-align: center;
            border: 2px solid var(--primary-color); border-radius: 12px;
            outline: none; width: 300px; letter-spacing: 2px;
        }
        .login-btn {
            margin-top: 20px; padding: 10px 30px; font-size: 18px;
            background: var(--primary-color); color: white; border: none;
            border-radius: 8px; cursor: pointer;
        }

        /* 頂部標題列 */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 20px; background: var(--card-bg);
            border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 10px; flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 1.4rem; color: var(--primary-color); letter-spacing: 2px; }
        .controls { display: flex; gap: 10px; align-items: center; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; background: #eee; color: #666; }
        #syncStatus { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; margin-right: 5px; }
        #syncStatus.active { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        /* 主畫面 Grid 佈局 */
        #mainContainer {
            display: grid;
            grid-template-columns: 35% 65%;
            grid-template-rows: auto 1fr auto; 
            gap: 15px; 
            flex: 1;
            height: 100%;
            min-height: 0; 
        }

        /* 卡片共用樣式 */
        .card {
            background: var(--card-bg); border-radius: 12px;
            padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            position: relative; display: flex; flex-direction: column;
            overflow: hidden; transition: all 0.5s ease;
        }
        .card-header {
            font-size: 1.2rem; font-weight: bold; color: var(--primary-color);
            margin-bottom: 10px; border-left: 4px solid var(--primary-color);
            padding-left: 8px; display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }

        /* 按鈕樣式 */
        .btn { padding: 4px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .btn-edit { background: #eee; color: #555; }
        .btn-save { background: var(--primary-color); color: white; }

        /* 1. 時鐘區 (Clock) */
        #clockCard { justify-content: center; align-items: center; text-align: center; }
        
        /* [修正重點1] 字體縮小為 12vw，確保手機直立時 8 個字也不會切掉 */
        #timeDisplay { 
            font-family: 'Courier New', monospace; font-weight: bold; 
            color: var(--clock-color); line-height: 1; 
            white-space: nowrap;
            /* 預設大小 (自習模式) */
            font-size: min(8vw, 10vh); 
        }
        #dateDisplay { font-size: 1.2rem; color: #888; margin-top: 5px; }
        
        /* 倒數區塊 */
        #countdownArea {
            width: 100%; margin-top: 15px; display: none; animation: fadeIn 0.5s;
        }
        .progress-container {
            width: 100%; height: 25px; background-color: #eee;
            border-radius: 12px; overflow: hidden; margin-top: 8px;
        }
        .progress-bar {
            height: 100%; width: 100%; background-color: var(--danger-color);
            transition: width 1s linear;
        }
        #countdownText {
            font-size: 1.8rem; font-weight: bold; color: var(--danger-color); display: block;
        }

        /* 2. 考程表 (Schedule) */
        #scheduleCard { overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 0; }
        th { text-align: left; color: #666; border-bottom: 2px solid #eee; padding: 8px; font-size: 0.9rem; position: sticky; top: 0; background: white;}
        td { padding: 12px 8px; border-bottom: 1px solid #f5f5f5; font-size: 1.1rem; color: var(--text-main); font-weight: bold;}
        tr.past-row td { color: var(--text-light); font-weight: normal; }
        tr.current-row { background-color: rgba(107, 142, 136, 0.15); border-left: 4px solid var(--primary-color); }

        /* 3. 公告區 (Info) */
        #infoCard { display: flex; flex-direction: column; }
        #announcementContent {
            white-space: pre-line; font-size: 1.3rem; line-height: 1.6; color: #444;
            overflow-y: auto; flex: 1;
        }
        #hurryImageContainer {
            margin-top: 10px; display: none; justify-content: center; align-items: center;
            height: 40%; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #hurryImage {
            max-height: 100%; max-width: 100%; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); object-fit: contain;
        }

        /* 4. 出缺席 (Attendance) */
        #attendanceCard {
            grid-column: 1 / -1;
            display: flex; justify-content: flex-start; align-items: center;
            padding: 10px 20px; background: var(--primary-color); color: white;
            position: relative; min-height: 80px; 
        }
        .att-group { display: flex; align-items: center; gap: 5px; margin-right: 35px; }
        .att-label { font-size: 1.2rem; opacity: 0.9; }
        .att-val { 
            font-size: 1.8rem; font-weight: bold; width: 70px; text-align: center;
            background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 8px;
            padding: 2px;
        }
        .att-unit { font-size: 1rem; margin-left: 3px; }
        #absentVal { width: 300px; text-align: left; padding-left: 10px; font-size: 1.5rem; }
        .signature {
            position: absolute; bottom: 8px; right: 15px;
            font-size: 0.8rem; color: rgba(255,255,255,0.4); font-weight: normal; letter-spacing: 1px;
        }

        /* ============ 模式切換 ============ */
        body.mode-exam #mainContainer {
            grid-template-columns: 60% 40%;
            grid-template-areas: "clock info" "clock info" "att att";
        }
        body.mode-exam #clockCard { grid-area: clock; }
        body.mode-exam #infoCard { grid-area: info; }
        body.mode-exam #scheduleCard { display: none; }
        body.mode-exam #attendanceCard { grid-area: att; }
        
        /* [修正重點1] 考試模式字體限制更嚴格，確保不切邊 */
        body.mode-exam #timeDisplay { font-size: min(12vw, 20vh); } 

        body.mode-study #mainContainer {
            grid-template-columns: 40% 60%;
            grid-template-areas: "schedule clock" "schedule info" "att att";
        }
        body.mode-study #scheduleCard { grid-area: schedule; }
        body.mode-study #clockCard { grid-area: clock; }
        body.mode-study #infoCard { grid-area: info; }
        body.mode-study #attendanceCard { grid-area: att; }
        body.mode-study #timeDisplay { font-size: min(7vw, 15vh); }

        /* Helpers */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 600px; max-height: 80vh; overflow-y: auto; }
        .edit-row { display: grid; grid-template-columns: 1fr 1fr 1.5fr 1fr auto; gap: 5px; margin-bottom: 10px; }
        .edit-row input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; }
        .admin-only { display: none !important; }
        body.role-admin .admin-only { display: inline-block !important; }
        input:not(:read-only) { background: rgba(255,255,255,0.2); border: 1px dashed rgba(255,255,255,0.5); cursor: text; }
        input:read-only { cursor: default; outline: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes blink { 50% { opacity: 0.5; } }
        .urgent { animation: blink 1s infinite; color: var(--danger-color); }

    </style>
</head>
<body class="mode-study">

    <div id="loginOverlay">
        <h2 style="color:var(--primary-color); margin-bottom:30px;">定期評量數位看板系統</h2>
        <div class="login-box">
            <input type="password" id="passInput" placeholder="身份驗證碼" onkeyup="if(event.key==='Enter') login()">
            <br>
            <div style="text-align: center;">
                <button class="login-btn" onclick="login()">登入</button>
            </div>
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:center;">
            <h1>定期評量數位看板</h1>
            <span id="syncStatus" style="margin-left:15px;" title="同步狀態燈"></span>
        </div>
        <div class="controls">
            <span id="currentModeBadge" class="status-badge">載入中...</span>
            <button class="btn btn-edit admin-only" onclick="toggleForceMode()">強制切換模式</button>
            <button class="btn btn-edit" onclick="logout()" style="background:#e74c3c; color:white;">登出</button>
        </div>
    </header>

    <div id="mainContainer">
        <div class="card" id="infoCard">
            <div class="card-header">
                公告事項
                <button class="btn btn-edit admin-only" onclick="editInfo()">✎ 編輯</button>
            </div>
            <div id="announcementContent">讀取中...</div>
            <div id="hurryImageContainer">
                <img id="hurryImage" src="hurry.jpg" alt="快寫完了"> 
            </div>
        </div>

        <div class="card" id="scheduleCard">
            <div class="card-header">
                今日考程
                <button class="btn btn-edit admin-only" onclick="openScheduleEditor()">✎ 編輯</button>
            </div>
            <table id="scheduleTable">
                <thead><tr><th>時間</th><th>科目</th><th>備註</th></tr></thead>
                <tbody id="scheduleBody"></tbody>
            </table>
        </div>

        <div class="card" id="clockCard">
            <div id="timeDisplay">00:00:00</div>
            <div id="dateDisplay">--月--日 星期--</div>
            
            <div id="countdownArea">
                <span id="countdownText">倒數 5 分鐘</span>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
        </div>

        <div class="card" id="attendanceCard">
            <div class="att-group">
                <span class="att-label">應到</span>
                <input type="number" id="shouldVal" class="att-val admin-only-edit" value="37" readonly onchange="saveData()">
                <span class="att-unit">人</span>
            </div>
            <div class="att-group">
                <span class="att-label">實到</span>
                <input type="number" id="actualVal" class="att-val" value="37" readonly onchange="saveData()">
                <span class="att-unit">人</span>
            </div>
            <div class="att-group" style="flex:1;">
                <span class="att-label">缺席座號</span>
                <input type="text" id="absentVal" class="att-val" placeholder="無" readonly onchange="saveData()">
            </div>
            <div class="signature">大安高工陳吳煜老師製</div>
        </div>
    </div>

    <div id="editorModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary-color)">編輯考程</h3>
            <div id="editorRows"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn" onclick="addEditorRow()" style="background:#eee;">+ 新增一節</button>
                <button class="btn btn-save" onclick="saveScheduleFromEditor()">儲存</button>
                <button class="btn" onclick="closeEditor()">取消</button>
            </div>
        </div>
    </div>

    <script>
        // === 您的 Google Sheet CSV 連結 (已預填) ===
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQACAdB7m2Bb2uYz7aIHU5TdXo5254vD0lpaKBkkyw621OEPW0hzHMdcFa5isuUDotgbFq7GRFghl9c/pub?output=csv";

        const PASSWORDS = { ADMIN: '1005', STUDENT: '1630' };
        let currentUserRole = null;
        let isForceMode = false;

        // [修正重點3] 更新預設公告內容
        const DEFAULT_ANNOUNCEMENT = `考試期間請遵守以下規定：
1. 請將手機及智慧型穿戴裝置關機並放置於手機袋。
2. 書包請放置於教室前、後方走道。
3. 桌子請轉向（抽屜朝向講桌）。
4. 桌面僅留下必要的文具用品。
5. 考試期間請勿交談。`;

        const DEFAULT_SCHEDULE = [
            { start: "08:10", end: "09:00", subject: "國語文", note: "開書考" },
            { start: "09:10", end: "10:00", subject: "自習", note: "安靜自修" },
            { start: "10:10", end: "11:00", subject: "數學", note: "帶圓規" },
            { start: "11:10", end: "12:00", subject: "英語", note: "含英聽" }
        ];

        let appData = {
            schedule: JSON.parse(JSON.stringify(DEFAULT_SCHEDULE)),
            announcement: DEFAULT_ANNOUNCEMENT,
            attendance: { should: 37, actual: 37, absent: "" }
        };

        function init() {
            if(GOOGLE_SHEET_CSV_URL && GOOGLE_SHEET_CSV_URL.length > 10) {
                fetchGoogleSheetData();
                setInterval(fetchGoogleSheetData, 10000);
            } else {
                loadLocalData();
            }

            updateClock();
            setInterval(updateClock, 1000);
            renderUI();
            
            const savedRole = localStorage.getItem('role');
            if(savedRole) authSuccess(savedRole);
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('timeDisplay').textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
            document.getElementById('dateDisplay').textContent = 
                now.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'long' });

            if (!isForceMode) checkScheduleMode(now);
            renderScheduleColor(now);
        }

        function checkScheduleMode(now) {
            const nowTime = now.getHours() * 60 + now.getMinutes();
            let isExamining = false;
            let currentSubject = "";
            let remainingSec = 0;

            appData.schedule.forEach((item) => {
                const [sH, sM] = item.start.split(':').map(Number);
                const [eH, eM] = item.end.split(':').map(Number);
                const startMin = sH * 60 + sM;
                const endMin = eH * 60 + eM;

                if (nowTime >= startMin && nowTime < endMin) {
                    if (item.subject !== "自習" && item.subject !== "午休") {
                        isExamining = true;
                        currentSubject = item.subject;
                        const endDate = new Date();
                        endDate.setHours(eH, eM, 0);
                        remainingSec = (endDate - now) / 1000;
                    }
                }
            });

            const body = document.body;
            const badge = document.getElementById('currentModeBadge');

            if (isExamining) {
                if(!body.classList.contains('mode-exam')) {
                    body.classList.remove('mode-study');
                    body.classList.add('mode-exam');
                }
                badge.textContent = `考試中：${currentSubject}`;
                handleCountdown(remainingSec);
            } else {
                if(!body.classList.contains('mode-study')) {
                    body.classList.remove('mode-exam');
                    body.classList.add('mode-study');
                }
                badge.textContent = "自習/下課時段";
                document.getElementById('countdownArea').style.display = 'none';
                document.getElementById('hurryImageContainer').style.display = 'none';
            }
        }

        function renderScheduleColor(now) {
            const rows = document.querySelectorAll('#scheduleBody tr');
            const nowTime = now.getHours() * 60 + now.getMinutes();

            appData.schedule.forEach((item, index) => {
                if(!rows[index]) return;
                const [eH, eM] = item.end.split(':').map(Number);
                const [sH, sM] = item.start.split(':').map(Number);
                const endMin = eH * 60 + eM;
                const startMin = sH * 60 + sM;
                
                rows[index].className = ''; 
                if (nowTime >= endMin) rows[index].classList.add('past-row'); 
                else if (nowTime >= startMin && nowTime < endMin) rows[index].classList.add('current-row');
            });
        }

        function handleCountdown(remainingSec) {
            const area = document.getElementById('countdownArea');
            const text = document.getElementById('countdownText');
            const bar = document.getElementById('progressBar');
            const imgContainer = document.getElementById('hurryImageContainer');

            if (remainingSec <= 300 && remainingSec > 0) {
                area.style.display = 'block';
                const mins = Math.ceil(remainingSec / 60);
                
                if (mins > 1) {
                    text.textContent = `倒數 ${mins} 分鐘`;
                    text.classList.remove('urgent');
                    imgContainer.style.display = 'none';
                } else if (remainingSec > 10) {
                    text.textContent = `倒數 1 分鐘`;
                    text.classList.add('urgent');
                    imgContainer.style.display = 'flex';
                } else {
                    text.textContent = `準備交卷`;
                    imgContainer.style.display = 'flex'; 
                }
                const percent = (remainingSec / 300) * 100;
                bar.style.width = `${percent}%`;
            } else {
                area.style.display = 'none';
                imgContainer.style.display = 'none';
            }
        }

        function login() {
            const val = document.getElementById('passInput').value;
            if (val === PASSWORDS.ADMIN) authSuccess('admin');
            else if (val === PASSWORDS.STUDENT) authSuccess('student');
            else { alert("驗證碼錯誤"); document.getElementById('passInput').value = ""; }
        }

        function authSuccess(role) {
            currentUserRole = role;
            localStorage.setItem('role', role);
            document.getElementById('loginOverlay').classList.add('hidden');
            document.body.classList.remove('role-admin', 'role-student');
            document.body.classList.add(`role-${role}`);
            
            const inputs = document.querySelectorAll('.att-val');
            inputs.forEach(input => {
                if(role === 'admin') input.removeAttribute('readonly');
                else {
                    if(input.id === 'shouldVal') input.setAttribute('readonly', true);
                    else input.removeAttribute('readonly');
                }
            });
        }

        function logout() { localStorage.removeItem('role'); location.reload(); }
        function toggleForceMode() {
            isForceMode = !isForceMode;
            if(document.body.classList.contains('mode-exam')) {
                document.body.classList.remove('mode-exam'); body.classList.add('mode-study');
            } else {
                document.body.classList.remove('mode-study'); body.classList.add('mode-exam');
            }
            document.getElementById('currentModeBadge').textContent = isForceMode ? "手動模式" : "自動模式";
        }

        function renderUI() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            appData.schedule.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.start}-${item.end}</td><td>${item.subject}</td><td>${item.note}</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('announcementContent').textContent = appData.announcement;
            document.getElementById('shouldVal').value = appData.attendance.should;
            document.getElementById('actualVal').value = appData.attendance.actual;
            document.getElementById('absentVal').value = appData.attendance.absent;
        }

        function editInfo() {
            const newText = prompt("編輯公告內容", appData.announcement);
            if(newText !== null) { appData.announcement = newText; saveData(); renderUI(); }
        }
        function openScheduleEditor() {
            const container = document.getElementById('editorRows');
            container.innerHTML = '';
            appData.schedule.forEach(item => addEditorRow(item));
            document.getElementById('editorModal').style.display = 'flex';
        }
        function addEditorRow(data = {start:'', end:'', subject:'', note:''}) {
            const div = document.createElement('div');
            div.className = 'edit-row';
            div.innerHTML = `
                <input type="time" class="e-start" value="${data.start}">
                <input type="time" class="e-end" value="${data.end}">
                <input type="text" class="e-sub" placeholder="科目" value="${data.subject}">
                <input type="text" class="e-note" placeholder="備註" value="${data.note}">
                <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none;">✖</button>
            `;
            document.getElementById('editorRows').appendChild(div);
        }
        function saveScheduleFromEditor() {
            const rows = document.querySelectorAll('.edit-row');
            const newSchedule = [];
            rows.forEach(row => {
                const start = row.querySelector('.e-start').value;
                const end = row.querySelector('.e-end').value;
                const subject = row.querySelector('.e-sub').value;
                const note = row.querySelector('.e-note').value;
                if(start && end && subject) newSchedule.push({ start, end, subject, note });
            });
            newSchedule.sort((a, b) => a.start.localeCompare(b.start));
            appData.schedule = newSchedule;
            saveData();
            renderUI();
            closeEditor();
        }
        function closeEditor() { document.getElementById('editorModal').style.display = 'none'; }
        function saveData() {
            appData.attendance.should = document.getElementById('shouldVal').value;
            appData.attendance.actual = document.getElementById('actualVal').value;
            appData.attendance.absent = document.getElementById('absentVal').value;
            localStorage.setItem('examDashboardData', JSON.stringify(appData));
        }
        function loadLocalData() {
            const saved = localStorage.getItem('examDashboardData');
            if(saved) appData = JSON.parse(saved);
        }

        // [修正重點2] 智慧解析 CSV：自動過濾標題列，合併公告
        function fetchGoogleSheetData() {
            const urlWithNoCache = GOOGLE_SHEET_CSV_URL + "&t=" + Date.now();
            const statusLight = document.getElementById('syncStatus');
            
            fetch(urlWithNoCache, {cache: "no-store"})
            .then(response => response.text())
            .then(csvText => {
                const rows = csvText.split('\n').map(row => row.split(','));
                
                if(rows.length > 2) {
                    statusLight.classList.add('active'); 
                    setTimeout(() => statusLight.classList.remove('active'), 1000);

                    // 1. 尋找「考程標題」在哪一行 (含有 "Start" 或 "Subject" 的那行)
                    let headerIndex = -1;
                    for(let i=0; i<rows.length; i++) {
                        const rowStr = rows[i].join('').toLowerCase();
                        if(rowStr.includes('start') && rowStr.includes('subject')) {
                            headerIndex = i;
                            break;
                        }
                    }

                    // 2. 處理公告：將 Header 以前的所有第一欄文字合併
                    if(headerIndex > 0) {
                        let announcementLines = [];
                        for(let i=0; i<headerIndex; i++) {
                            // 去除 CSV 可能產生的多餘引號
                            let line = rows[i][0].replace(/^"|"$/g, '').replace(/\\n/g, '\n');
                            if(line.trim()) announcementLines.push(line);
                        }
                        if(announcementLines.length > 0) {
                            appData.announcement = announcementLines.join('\n');
                        }
                    } else {
                        // 如果找不到 Header，就照舊只讀第一行 (fallback)
                        if(rows[0][0]) appData.announcement = rows[0][0].replace(/\\n/g, '\n');
                    }

                    // 3. 處理考程：從 Header 的下一行開始讀
                    const startIndex = (headerIndex !== -1) ? headerIndex + 1 : 2;
                    const newSchedule = [];
                    for(let i=startIndex; i<rows.length; i++) {
                        const [start, end, subject, note] = rows[i];
                        // 再次確認不是標題列 (雙重保險)
                        if (!start || start.toLowerCase().includes("start")) continue;

                        if(start && end && subject) {
                            newSchedule.push({
                                start: start.trim().replace(/"/g,''),
                                end: end.trim().replace(/"/g,''),
                                subject: subject.trim().replace(/"/g,''),
                                note: note ? note.trim().replace(/"/g,'') : ""
                            });
                        }
                    }
                    if(newSchedule.length > 0) {
                        appData.schedule = newSchedule;
                        renderUI();
                    }
                }
            })
            .catch(err => console.error("同步失敗:", err));
        }

        init();
    </script>
</body>
</html>
