<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>定期評量數位看板</title>
    <style>
        :root {
            --bg-color: #EEF2E6; 
            --card-bg: #FFFFFF;
            --primary-color: #6B8E88; 
            --text-main: #2C3E50; 
            --text-light: #B0B0B0;
            --danger-color: #E07A5F; 
            --clock-color: #2F3E46;
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-color);
            margin: 0; 
            padding: 15px; 
            color: var(--text-main);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden; 
        }

        /* 登入遮罩 */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(238, 242, 230, 0.98);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 0.5s;
        }
        #loginOverlay.hidden { opacity: 0; pointer-events: none; }
        
        .login-box input {
            padding: 15px; font-size: 28px; text-align: center;
            border: 2px solid var(--primary-color); border-radius: 12px;
            outline: none; width: 300px; letter-spacing: 2px;
        }
        .login-btn {
            margin-top: 20px; padding: 10px 30px; font-size: 18px;
            background: var(--primary-color); color: white; border: none;
            border-radius: 8px; cursor: pointer;
        }

        /* 頂部標題列 */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 5px 15px; background: var(--card-bg);
            border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 8px; 
            flex-shrink: 0;
            height: 50px;
        }
        h1 { margin: 0; font-size: 1.2rem; color: var(--primary-color); letter-spacing: 2px; }
        .controls { display: flex; gap: 8px; align-items: center; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; background: #eee; color: #666; }
        #syncStatus { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; margin-right: 5px; }
        #syncStatus.active { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        /* === 主畫面佈局 === */
        #mainContainer {
            display: flex;
            flex-direction: row; 
            gap: 12px;
            flex: 1; 
            min-height: 0; 
            margin-bottom: 25px; 
        }

        /* 左側欄位容器 */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 12px; 
        }

        /* 右側欄位容器 */
        .right-column {
            display: flex;
            flex-direction: column;
        }

        /* 卡片共用樣式 */
        .card {
            background: var(--card-bg); border-radius: 12px;
            padding: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            position: relative; display: flex; flex-direction: column;
            overflow: hidden; 
        }
        .card-header {
            font-size: 1.1rem; font-weight: bold; color: var(--primary-color);
            margin-bottom: 5px; border-left: 4px solid var(--primary-color);
            padding-left: 8px; display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }

        .btn { padding: 3px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
        .btn-edit { background: #eee; color: #555; }
        .btn-save { background: var(--primary-color); color: white; }

        /* 1. 時鐘區 */
        #clockCard { 
            justify-content: center; align-items: center; text-align: center;
            flex-shrink: 0; 
            position: relative;
        }
        
        #timeDisplay { 
            font-family: 'Courier New', monospace; font-weight: bold; 
            color: var(--clock-color); line-height: 1; 
            white-space: nowrap;
        }
        
        #dateDisplay { 
            font-size: 1.8rem; font-weight: bold; margin-top: 10px; 
            color: var(--primary-color); 
        }
        
        /* [修正1] 警語加大、加深 */
        #timeDisclaimer {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 1rem; /* 加大 */
            color: #444; /* 加深，與公告同色 */
            display: none; 
            font-weight: bold; /* 加粗 */
            text-align: right;
        }

        /* 倒數區塊 */
        #countdownArea { width: 100%; margin-top: 5px; display: none; }
        .progress-container { width: 100%; height: 15px; background-color: #eee; border-radius: 12px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; width: 100%; background-color: var(--danger-color); transition: width 1s linear; }
        #countdownText { font-size: 1.3rem; font-weight: bold; color: var(--danger-color); display: block; }

        /* 2. 公告區 */
        #infoCard { 
            flex: 1; 
            min-height: 0; 
        }
        #announcementContent {
            white-space: pre-line; font-size: 1.25rem; line-height: 1.4; color: #444;
            overflow-y: auto; flex: 1;
        }
        #hurryImageContainer {
            margin-top: 5px; display: none; justify-content: center; align-items: center;
            height: 40%; 
        }
        #hurryImage { max-height: 100%; max-width: 100%; border-radius: 12px; object-fit: contain; }

        /* 3. 考程表區 */
        #scheduleCard { 
            height: 100%; 
        }
        table { width: 100%; border-collapse: collapse; margin-top: 0; }
        th { text-align: left; color: #666; border-bottom: 2px solid #eee; padding: 6px; font-size: 0.9rem; position: sticky; top: 0; background: white;}
        td { padding: 10px 6px; border-bottom: 1px solid #f5f5f5; font-size: 1.05rem; color: var(--text-main); font-weight: bold;}
        tr.past-row td { color: var(--text-light); font-weight: normal; }
        tr.current-row { background-color: rgba(107, 142, 136, 0.15); border-left: 4px solid var(--primary-color); }

        /* 4. 出缺席區 */
        #attendanceCard {
            height: 130px; 
            display: flex; flex-direction: column; justify-content: center; 
            padding: 10px 25px; background: var(--primary-color); color: white;
            position: relative; 
            border-radius: 12px;
            flex-shrink: 0;
            gap: 15px; 
        }
        
        .att-top-row {
            display: flex; justify-content: center; align-items: center;
            width: 100%;
            gap: 60px; 
        }
        
        .att-group { display: flex; align-items: center; gap: 8px; }
        .att-label { font-size: 1.4rem; opacity: 0.95; }
        .att-val { 
            font-size: 2.2rem; font-weight: bold; width: 70px; text-align: center;
            background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 8px;
            padding: 0px;
        }
        .att-unit { font-size: 1.1rem; margin-left: 5px; opacity: 0.8; }
        
        .att-bottom-row {
            display: flex; justify-content: center; align-items: center;
            width: 100%;
            gap: 15px;
        }
        
        .att-bottom-row .att-label { font-size: 1.4rem; white-space: nowrap; }
        
        #absentVal { 
            width: 60%; 
            text-align: left; padding-left: 15px; font-size: 1.4rem; 
            background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 8px; height: 45px;
        }

        .signature {
            position: absolute; bottom: 5px; right: 10px;
            font-size: 0.9rem; color: rgba(255,255,255,0.8); font-weight: normal; letter-spacing: 1px;
        }

        /* ============ 模式切換邏輯 ============ */
        
        body.mode-study .left-column { width: 50%; }
        body.mode-study .right-column { width: 50%; }
        body.mode-study #clockCard { height: auto; padding: 10px; }
        body.mode-study #timeDisplay { font-size: 5vw; }

        body.mode-exam .left-column { width: 50%; }
        body.mode-exam .right-column { width: 50%; }
        body.mode-exam #clockCard { flex: 1; } 
        body.mode-exam #infoCard { display: none; } 
        body.mode-exam #scheduleCard { display: none; }
        body.mode-exam #timeDisclaimer { display: block; } 
        body.mode-exam #timeDisplay { font-size: min(8.5vw, 20vh); }

        /* Helpers */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 600px; max-height: 80vh; overflow-y: auto; }
        .edit-row { display: grid; grid-template-columns: 1fr 1fr 1.5fr 1fr auto; gap: 5px; margin-bottom: 10px; }
        .edit-row input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; }
        .admin-only { display: none !important; }
        body.role-admin .admin-only { display: inline-block !important; }
        input:not(:read-only) { background: rgba(255,255,255,0.2); border: 1px dashed rgba(255,255,255,0.5); cursor: text; }
        input:read-only { cursor: default; outline: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes blink { 50% { opacity: 0.5; } }
        .urgent { animation: blink 1s infinite; color: var(--danger-color); }

    </style>
</head>
<body class="mode-study">

    <div id="loginOverlay">
        <h2 style="color:var(--primary-color); margin-bottom:30px;">定期評量數位看板系統</h2>
        <div class="login-box">
            <input type="password" id="passInput" placeholder="身份驗證碼" onkeyup="if(event.key==='Enter') login()">
            <br>
            <div style="text-align: center;">
                <button class="login-btn" onclick="login()">登入</button>
            </div>
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:center;">
            <h1>定期評量數位看板</h1>
            <span id="syncStatus" style="margin-left:15px;" title="同步狀態燈"></span>
        </div>
        <div class="controls">
            <span id="currentModeBadge" class="status-badge">載入中...</span>
            <button class="btn btn-edit admin-only" onclick="toggleForceMode()">強制切換模式</button>
            <button class="btn btn-edit" onclick="logout()" style="background:#e74c3c; color:white;">登出</button>
        </div>
    </header>

    <div id="mainContainer">
        <div class="left-column" id="colLeft">
            <div class="card" id="clockCard">
                <div id="timeDisplay">00:00:00</div>
                <div id="dateDisplay">--月--日 星期--</div>
                <div id="timeDisclaimer">以上網路時間僅供參考，請同學仍應依學校鐘聲為準。</div>
                <div id="countdownArea">
                    <span id="countdownText">倒數 5 分鐘</span>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
            </div>
            
            <div class="card" id="infoCard">
                <div class="card-header">
                    公告事項
                    <button class="btn btn-edit admin-only" onclick="editInfo()">✎ 編輯</button>
                </div>
                <div id="announcementContent">讀取中...</div>
                <div id="hurryImageContainer">
                    <img id="hurryImage" src="hurry.jpg" alt="快寫完了"> 
                </div>
            </div>
        </div>

        <div class="right-column" id="colRight">
            <div class="card" id="scheduleCard">
                <div class="card-header">
                    今日考程
                    <button class="btn btn-edit admin-only" onclick="openScheduleEditor()">✎ 編輯</button>
                </div>
                <table id="scheduleTable">
                    <thead><tr><th>時間</th><th>科目</th><th>備註</th></tr></thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card" id="attendanceCard">
        <div class="att-top-row">
            <div class="att-group">
                <span class="att-label">應到</span>
                <input type="number" id="shouldVal" class="att-val admin-only-edit" value="37" readonly onchange="saveData()">
                <span class="att-unit">人</span>
            </div>
            <div class="att-group">
                <span class="att-label">實到</span>
                <input type="number" id="actualVal" class="att-val" value="37" readonly onchange="saveData()">
                <span class="att-unit">人</span>
            </div>
        </div>
        
        <div class="att-bottom-row">
            <span class="att-label">缺席座號</span>
            <input type="text" id="absentVal" class="att-val" placeholder="無" readonly onchange="saveData()">
        </div>
        
        <div class="signature">大安高工陳吳煜老師製</div>
    </div>

    <div id="editorModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary-color)">編輯考程</h3>
            <div id="editorRows"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn" onclick="addEditorRow()" style="background:#eee;">+ 新增一節</button>
                <button class="btn btn-save" onclick="saveScheduleFromEditor()">儲存</button>
                <button class="btn" onclick="closeEditor()">取消</button>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQACAdB7m2Bb2uYz7aIHU5TdXo5254vD0lpaKBkkyw621OEPW0hzHMdcFa5isuUDotgbFq7GRFghl9c/pub?output=csv";
        const PASSWORDS = { ADMIN: '1005', STUDENT: '1630' };
        let currentUserRole = null;
        let isForceMode = false;
        
        const DEFAULT_ANNOUNCEMENT = `考試期間請遵守以下規定：
1. 請將手機及智慧型穿戴裝置關機並放置於手機袋。
2. 書包請放置於教室前、後方走道。
3. 桌子請轉向（抽屜朝向講桌）。
4. 桌面僅留下必要的文具用品。
5. 考試期間請勿交談。`;

        const DEFAULT_SCHEDULE = [
            { start: "08:20", end: "09:10", subject: "第一節", note: "" },
            { start: "09:20", end: "10:10", subject: "第二節", note: "" },
            { start: "10:20", end: "11:10", subject: "第三節", note: "" },
            { start: "11:20", end: "12:10", subject: "第四節", note: "" },
            { start: "13:10", end: "14:00", subject: "第五節", note: "" },
            { start: "14:10", end: "15:00", subject: "第六節", note: "" },
            { start: "15:10", end: "16:00", subject: "第七節", note: "" }
        ];

        let appData = {
            schedule: JSON.parse(JSON.stringify(DEFAULT_SCHEDULE)),
            announcement: DEFAULT_ANNOUNCEMENT,
            attendance: { should: 37, actual: 37, absent: "" }
        };

        function init() {
            if(GOOGLE_SHEET_CSV_URL && GOOGLE_SHEET_CSV_URL.length > 10) {
                fetchGoogleSheetData();
                // [修正2] 改為 60 秒 (60000ms) 檢查一次
                setInterval(fetchGoogleSheetData, 60000);
            } else {
                loadLocalData();
            }
            updateClock();
            setInterval(updateClock, 1000);
            renderUI();
            const savedRole = localStorage.getItem('role');
            if(savedRole) authSuccess(savedRole);
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('timeDisplay').textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
            document.getElementById('dateDisplay').textContent = now.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'long' });
            if (!isForceMode) checkScheduleMode(now);
            renderScheduleColor(now);
        }

        function checkScheduleMode(now) {
            const nowTime = now.getHours() * 60 + now.getMinutes();
            let isExamining = false;
            let currentSubject = "";
            let remainingSec = 0;

            appData.schedule.forEach((item) => {
                const [sH, sM] = item.start.split(':').map(Number);
                const [eH, eM] = item.end.split(':').map(Number);
                const startMin = sH * 60 + sM;
                const endMin = eH * 60 + eM;
                if (nowTime >= startMin && nowTime < endMin) {
                    if (item.subject !== "自習" && item.subject !== "午休") {
                        isExamining = true;
                        currentSubject = item.subject;
                        const endDate = new Date();
                        endDate.setHours(eH, eM, 0);
                        remainingSec = (endDate - now) / 1000;
                    }
                }
            });

            const body = document.body;
            const badge = document.getElementById('currentModeBadge');
            const infoCard = document.getElementById('infoCard');
            const colLeft = document.getElementById('colLeft');
            const colRight = document.getElementById('colRight');

            if (isExamining) {
                if(!body.classList.contains('mode-exam')) {
                    body.classList.remove('mode-study');
                    body.classList.add('mode-exam');
                    colRight.appendChild(infoCard);
                    infoCard.style.display = 'flex'; 
                    infoCard.style.height = '100%'; 
                }
                badge.textContent = `考試中：${currentSubject}`;
                handleCountdown(remainingSec);
            } else {
                if(!body.classList.contains('mode-study')) {
                    body.classList.remove('mode-exam');
                    body.classList.add('mode-study');
                    colLeft.appendChild(infoCard);
                }
                badge.textContent = "自習/下課時段";
                document.getElementById('countdownArea').style.display = 'none';
                document.getElementById('hurryImageContainer').style.display = 'none';
            }
        }

        function renderScheduleColor(now) {
            const rows = document.querySelectorAll('#scheduleBody tr');
            const nowTime = now.getHours() * 60 + now.getMinutes();
            appData.schedule.forEach((item, index) => {
                if(!rows[index]) return;
                const [eH, eM] = item.end.split(':').map(Number);
                const [sH, sM] = item.start.split(':').map(Number);
                const endMin = eH * 60 + eM;
                const startMin = sH * 60 + sM;
                rows[index].className = ''; 
                if (nowTime >= endMin) rows[index].classList.add('past-row'); 
                else if (nowTime >= startMin && nowTime < endMin) rows[index].classList.add('current-row');
            });
        }

        function handleCountdown(remainingSec) {
            const area = document.getElementById('countdownArea');
            const text = document.getElementById('countdownText');
            const bar = document.getElementById('progressBar');
            const imgContainer = document.getElementById('hurryImageContainer');
            if (remainingSec <= 300 && remainingSec > 0) {
                area.style.display = 'block';
                const mins = Math.ceil(remainingSec / 60);
                if (mins > 1) {
                    text.textContent = `倒數 ${mins} 分鐘`;
                    text.classList.remove('urgent');
                    imgContainer.style.display = 'none';
                } else if (remainingSec > 10) {
                    text.textContent = `倒數 1 分鐘`;
                    text.classList.add('urgent');
                    imgContainer.style.display = 'flex';
                } else {
                    text.textContent = `準備交卷`;
                    imgContainer.style.display = 'flex'; 
                }
                const percent = (remainingSec / 300) * 100;
                bar.style.width = `${percent}%`;
            } else {
                area.style.display = 'none';
                imgContainer.style.display = 'none';
            }
        }

        function login() {
            const val = document.getElementById('passInput').value;
            if (val === PASSWORDS.ADMIN) authSuccess('admin');
            else if (val === PASSWORDS.STUDENT) authSuccess('student');
            else { alert("驗證碼錯誤"); document.getElementById('passInput').value = ""; }
        }

        function authSuccess(role) {
            currentUserRole = role;
            localStorage.setItem('role', role);
            document.getElementById('loginOverlay').classList.add('hidden');
            document.body.classList.remove('role-admin', 'role-student');
            document.body.classList.add(`role-${role}`);
            const inputs = document.querySelectorAll('.att-val');
            inputs.forEach(input => {
                if(role === 'admin') input.removeAttribute('readonly');
                else {
                    if(input.id === 'shouldVal') input.setAttribute('readonly', true);
                    else input.removeAttribute('readonly');
                }
            });
        }

        function logout() { localStorage.removeItem('role'); location.reload(); }
        function toggleForceMode() {
            isForceMode = !isForceMode;
            const now = new Date();
            if(document.body.classList.contains('mode-exam')) {
                document.body.classList.remove('mode-exam'); 
                document.body.classList.add('mode-study');
                document.getElementById('colLeft').appendChild(document.getElementById('infoCard'));
                document.getElementById('scheduleCard').style.display = 'flex';
                document.getElementById('timeDisclaimer').style.display = 'none';
            } else {
                document.body.classList.remove('mode-study'); 
                document.body.classList.add('mode-exam');
                document.getElementById('colRight').appendChild(document.getElementById('infoCard'));
                document.getElementById('scheduleCard').style.display = 'none';
                document.getElementById('infoCard').style.display = 'flex';
                document.getElementById('timeDisclaimer').style.display = 'block';
            }
            document.getElementById('currentModeBadge').textContent = isForceMode ? "手動模式" : "自動模式";
        }

        function renderUI() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            appData.schedule.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.start}-${item.end}</td><td>${item.subject}</td><td>${item.note}</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('announcementContent').textContent = appData.announcement;
            document.getElementById('shouldVal').value = appData.attendance.should;
            document.getElementById('actualVal').value = appData.attendance.actual;
            document.getElementById('absentVal').value = appData.attendance.absent;
        }

        function editInfo() {
            const newText = prompt("編輯公告內容", appData.announcement);
            if(newText !== null) { appData.announcement = newText; saveData(); renderUI(); }
        }
        function openScheduleEditor() {
            const container = document.getElementById('editorRows');
            container.innerHTML = '';
            appData.schedule.forEach(item => addEditorRow(item));
            document.getElementById('editorModal').style.display = 'flex';
        }
        function addEditorRow(data = {start:'', end:'', subject:'', note:''}) {
            const div = document.createElement('div');
            div.className = 'edit-row';
            div.innerHTML = `
                <input type="time" class="e-start" value="${data.start}">
                <input type="time" class="e-end" value="${data.end}">
                <input type="text" class="e-sub" placeholder="科目" value="${data.subject}">
                <input type="text" class="e-note" placeholder="備註" value="${data.note}">
                <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none;">✖</button>
            `;
            document.getElementById('editorRows').appendChild(div);
        }
        function saveScheduleFromEditor() {
            const rows = document.querySelectorAll('.edit-row');
            const newSchedule = [];
            rows.forEach(row => {
                const start = row.querySelector('.e-start').value;
                const end = row.querySelector('.e-end').value;
                const subject = row.querySelector('.e-sub').value;
                const note = row.querySelector('.e-note').value;
                if(start && end && subject) newSchedule.push({ start, end, subject, note });
            });
            newSchedule.sort((a, b) => a.start.localeCompare(b.start));
            appData.schedule = newSchedule;
            saveData();
            renderUI();
            closeEditor();
        }
        function closeEditor() { document.getElementById('editorModal').style.display = 'none'; }
        function saveData() {
            appData.attendance.should = document.getElementById('shouldVal').value;
            appData.attendance.actual = document.getElementById('actualVal').value;
            appData.attendance.absent = document.getElementById('absentVal').value;
            localStorage.setItem('examDashboardData', JSON.stringify(appData));
        }
        function loadLocalData() {
            const saved = localStorage.getItem('examDashboardData');
            if(saved) appData = JSON.parse(saved);
        }

        function fetchGoogleSheetData() {
            const urlWithNoCache = GOOGLE_SHEET_CSV_URL + "&t=" + Date.now();
            const statusLight = document.getElementById('syncStatus');
            fetch(urlWithNoCache, {cache: "no-store"})
            .then(response => response.text())
            .then(csvText => {
                // [修正3] 如果使用者正在打字 (focus 在 input 裡面)，就暫停這次的畫面更新，避免干擾
                if (document.activeElement.tagName === 'INPUT') {
                    console.log("使用者輸入中，暫停更新");
                    return;
                }

                const rows = csvText.split('\n').map(row => row.split(','));
                if(rows.length > 2) {
                    statusLight.classList.add('active'); 
                    setTimeout(() => statusLight.classList.remove('active'), 1000);
                    let headerIndex = -1;
                    for(let i=0; i<rows.length; i++) {
                        const rowStr = rows[i].join('').toLowerCase();
                        if(rowStr.includes('start') && rowStr.includes('subject')) {
                            headerIndex = i; break;
                        }
                    }
                    if(headerIndex > 0) {
                        let announcementLines = [];
                        for(let i=0; i<headerIndex; i++) {
                            let line = rows[i][0].replace(/^"|"$/g, '').replace(/\\n/g, '\n');
                            if(line.trim()) announcementLines.push(line);
                        }
                        if(announcementLines.length > 0) appData.announcement = announcementLines.join('\n');
                    } else {
                        if(rows[0][0]) appData.announcement = rows[0][0].replace(/\\n/g, '\n');
                    }
                    const startIndex = (headerIndex !== -1) ? headerIndex + 1 : 2;
                    const newSchedule = [];
                    for(let i=startIndex; i<rows.length; i++) {
                        const [start, end, subject, note] = rows[i];
                        if (!start || start.toLowerCase().includes("start")) continue;
                        if(start && end && subject) {
                            newSchedule.push({
                                start: start.trim().replace(/"/g,''),
                                end: end.trim().replace(/"/g,''),
                                subject: subject.trim().replace(/"/g,''),
                                note: note ? note.trim().replace(/"/g,'') : ""
                            });
                        }
                    }
                    if(newSchedule.length > 0) {
                        appData.schedule = newSchedule;
                        renderUI();
                    }
                }
            })
            .catch(err => console.error("同步失敗:", err));
        }
        init();
    </script>
</body>
</html>
