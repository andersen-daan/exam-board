<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>定期評量數位看板</title>
    <style>
        :root {
            --bg-color: #EEF2E6; 
            --card-bg: #FFFFFF;
            --primary-color: #6B8E88; 
            --text-main: #2C3E50; 
            --text-light: #B0B0B0;
            --danger-color: #E07A5F; 
            --clock-color: #2F3E46;
            --warning-yellow: #F4D35E; 
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 15px; padding-bottom: 25px; 
            color: var(--text-main);
            height: 100vh; height: 100dvh; width: 100vw;
            display: flex; flex-direction: column; overflow: hidden; 
            position: fixed; top: 0; left: 0;
        }

        /* 登入遮罩 */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(238, 242, 230, 0.98);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 6000; transition: opacity 0.5s;
        }
        #loginOverlay.hidden { opacity: 0; pointer-events: none; }
        
        /* 學生通知遮罩 */
        #studentOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        #studentOverlay.active { opacity: 1; }

        /* 訊息橫幅 (統一黃底黑字) */
        .overlay-message {
            width: 100%; display: flex; justify-content: center; align-items: center; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            pointer-events: auto; 
            background: var(--warning-yellow); color: #000; /* 統一配色 */
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .overlay-message h1 { font-size: clamp(2rem, 5vw, 4rem); margin: 0; font-weight: 900; line-height: 1.3; }

        .h-33 { height: 33vh; }
        .h-50 { height: 50vh; }
        .blink-effect { animation: blink-text 0.8s infinite; }

        /* 登入框 */
        .login-box input {
            padding: 15px; font-size: 28px; text-align: center;
            border: 2px solid var(--primary-color); border-radius: 12px;
            outline: none; width: 300px; letter-spacing: 2px;
        }
        .login-btn {
            margin-top: 20px; padding: 10px 30px; font-size: 18px;
            background: var(--primary-color); color: white; border: none;
            border-radius: 8px; cursor: pointer;
        }

        /* 標題列 */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; background: var(--card-bg);
            border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 8px; flex-shrink: 0; height: 50px;
            z-index: 3000; position: relative;
        }
        h1 { margin: 0; font-size: 1.6rem; color: var(--primary-color); letter-spacing: 2px; line-height: 50px; }
        .controls { display: flex; gap: 8px; align-items: center; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; background: #eee; color: #666; }
        #syncStatus { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; margin-right: 5px; }
        #syncStatus.active { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        /* 主佈局 */
        #mainContainer {
            display: flex; flex-direction: row; gap: 12px; flex: 1; min-height: 0; 
            margin-bottom: 15px; overflow: hidden;
        }
        .left-column, .right-column {
            display: flex; flex-direction: column; gap: 12px; 
            height: 100%; overflow: hidden;
        }

        .card {
            background: var(--card-bg); border-radius: 12px; padding: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            position: relative; display: flex; flex-direction: column; overflow: hidden; 
        }
        .card-header {
            font-size: 1.3rem; font-weight: bold; color: var(--primary-color);
            margin-bottom: 5px; border-left: 4px solid var(--primary-color);
            padding-left: 8px; display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }

        .btn { padding: 3px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
        .btn-edit { background: #eee; color: #555; }
        .btn-save { background: var(--primary-color); color: white; }

        /* 時鐘 */
        #clockCard { 
            justify-content: center; align-items: center; text-align: center;
            flex-shrink: 0; position: relative; min-height: 120px;
        }
        #timeDisplay { font-family: 'Courier New', monospace; font-weight: bold; color: var(--clock-color); line-height: 1; white-space: nowrap; }
        #dateDisplay { font-size: 1.8rem; font-weight: bold; margin-top: 5px; color: var(--primary-color); }
        #timeDisclaimer { position: absolute; bottom: 5px; right: 10px; font-size: 1rem; color: #444; display: none; font-weight: bold; text-align: right; }

        #countdownArea { width: 100%; margin-top: 5px; display: none; }
        .progress-container { width: 100%; height: 15px; background-color: #eee; border-radius: 12px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; width: 100%; background-color: var(--danger-color); transition: width 1s linear; }
        #countdownText { font-size: 1.3rem; font-weight: bold; color: var(--danger-color); display: block; }

        /* 公告 */
        #infoCard { flex: 1; min-height: 0; position: relative; }
        #announcementContent {
            white-space: pre-line; font-size: 1.3rem; line-height: 1.4; color: #444;
            overflow-y: auto; flex: 1; padding-right: 5px;
        }
        
        /* Hurry 圖片 */
        #hurryImageContainer {
            margin-top: 5px; display: none; justify-content: center; align-items: center; height: 40%; 
        }
        #hurryImageContainer.expanded {
            display: flex !important;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 50; 
            margin: 0; border-radius: 12px; padding: 10px;
        }
        #hurryImage { max-height: 100%; max-width: 100%; border-radius: 12px; object-fit: contain; }

        /* 考程 */
        #scheduleCard { height: 100%; min-height: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 0; }
        th { text-align: left; color: #666; border-bottom: 2px solid #eee; padding: 6px; font-size: 0.9rem; position: sticky; top: 0; background: white;}
        td { padding: 10px 6px; border-bottom: 1px solid #f5f5f5; font-size: 1.05rem; color: var(--text-main); font-weight: bold;}
        tr.past-row td { color: var(--text-light); font-weight: normal; }
        tr.current-row { background-color: rgba(107, 142, 136, 0.15); border-left: 4px solid var(--primary-color); }

        /* 出缺席 */
        #attendanceCard {
            height: 140px; flex-shrink: 0; 
            display: flex; flex-direction: column; justify-content: center; 
            padding: 5px 25px; background: var(--primary-color); color: white;
            position: relative; border-radius: 12px; gap: 10px; 
            z-index: 3000; 
        }
        .att-top-row { display: flex; justify-content: space-evenly; align-items: center; width: 100%; height: 50%; }
        .att-item-container { display: flex; justify-content: center; align-items: center; gap: 10px; }
        .att-label { font-size: 1.4rem; opacity: 0.95; white-space: nowrap; }
        .att-val { font-size: 2.2rem; font-weight: bold; width: 70px; text-align: center; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 8px; padding: 0px; }
        .att-unit { font-size: 1.1rem; margin-left: 5px; opacity: 0.8; }
        
        .att-bottom-row { display: flex; justify-content: center; align-items: center; width: 100%; height: 50%; gap: 10px; }
        .input-wrapper { display: flex; align-items: center; gap: 5px; flex: 1; max-width: 600px; }
        #absentVal { flex: 1; text-align: left; padding-left: 15px; font-size: 1.4rem; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 8px; height: 45px; }
        .btn-picker { background: #F2CC8F; color: #333; font-weight: bold; height: 45px; padding: 0 15px; border-radius: 8px; border: none; cursor: pointer; font-size: 1rem; white-space: nowrap; display: none; }
        .signature { position: absolute; bottom: 5px; right: 10px; font-size: 0.9rem; color: rgba(255,255,255,0.8); font-weight: normal; letter-spacing: 1px; }

        /* 選號器 */
        #seatModal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 6000; justify-content: center; align-items: center; }
        .seat-grid-container { background: white; padding: 15px; border-radius: 15px; width: 95%; max-width: 600px; max-height: 95vh; display: flex; flex-direction: column; }
        .seat-header { display: flex; justify-content: center; margin-bottom: 10px; color: var(--primary-color); font-size: 1.2rem; font-weight: bold; }
        
        .seat-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; margin: 0; flex: 1; overflow-y: auto; }
        .seat-btn { aspect-ratio: 1; display: flex; justify-content: center; align-items: center; font-size: 1rem; border-radius: 4px; border: 1px solid #ddd; background: white; cursor: pointer; color: #333; }
        .seat-btn.selected { background: var(--danger-color); color: white; border-color: var(--danger-color); }
        
        .seat-footer { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; }
        .btn-clear { background: #e74c3c; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; }
        .btn-confirm { background: var(--primary-color); color: white; padding: 8px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; margin-right: 10px;}
        .btn-cancel { background: #ccc; color: #333; padding: 8px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; }

        /* 編輯器 */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 6000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 600px; max-height: 80vh; overflow-y: auto; }
        .edit-row { display: grid; grid-template-columns: 1fr 1fr 1.5fr 1fr auto; gap: 5px; margin-bottom: 10px; }
        .edit-row input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; }

        /* 模式切換 */
        body.mode-study .left-column { width: 50%; }
        body.mode-study .right-column { width: 50%; }
        body.mode-study #clockCard { height: auto; padding: 10px; }
        body.mode-study #timeDisplay { font-size: 5vw; }

        body.mode-exam .left-column { width: 50%; }
        body.mode-exam .right-column { width: 50%; }
        body.mode-exam #clockCard { flex: 1; } 
        body.mode-exam #infoCard { display: none; } 
        body.mode-exam #scheduleCard { display: none; }
        body.mode-exam #timeDisclaimer { display: block; } 
        body.mode-exam #timeDisplay { font-size: min(8.5vw, 20vh); }

        body.role-admin .admin-only { display: inline-block !important; }
        body.role-admin .btn-picker, body.role-student .btn-picker { display: block !important; } 
        input:not(:read-only) { background: rgba(255,255,255,0.2); border: 1px dashed rgba(255,255,255,0.5); cursor: text; }
        input:read-only { cursor: default; outline: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes blink-text { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
    </style>
</head>
<body class="mode-study">

    <div id="loginOverlay">
        <h2 style="color:var(--primary-color); margin-bottom:30px;">定期評量數位看板系統</h2>
        <div class="login-box">
            <input type="password" id="passInput" placeholder="身份驗證碼" onkeyup="if(event.key==='Enter') login()">
            <br>
            <div style="text-align: center;">
                <button class="login-btn" onclick="login()">登入</button>
            </div>
        </div>
    </div>

    <div id="studentOverlay">
        <div class="overlay-message" id="overlayMessage"></div>
    </div>

    <header>
        <div style="display:flex; align-items:center;">
            <h1>定期評量數位看板</h1>
            <span id="syncStatus" style="margin-left:15px;" title="同步狀態燈"></span>
        </div>
        <div class="controls">
            <span id="currentModeBadge" class="status-badge">載入中...</span>
            <button class="btn btn-edit admin-only" onclick="toggleForceMode()">強制切換模式</button>
            <button class="btn btn-edit" onclick="logout()" style="background:#e74c3c; color:white;">登出</button>
        </div>
    </header>

    <div id="mainContainer">
        <div class="left-column" id="colLeft">
            <div class="card" id="clockCard">
                <div id="timeDisplay">00:00:00</div>
                <div id="dateDisplay">--月--日 星期--</div>
                <div id="timeDisclaimer">以上網路時間僅供參考，請同學仍應依學校鐘聲為準。</div>
                <div id="countdownArea">
                    <span id="countdownText">倒數 5 分鐘</span>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
            </div>
            
            <div class="card" id="infoCard">
                <div class="card-header">
                    公告事項
                    <button class="btn btn-edit admin-only" onclick="editInfo()">✎ 編輯</button>
                </div>
                <div id="announcementContent">讀取中...</div>
                <div id="hurryImageContainer">
                    <img id="hurryImage" src="hurry.jpg" alt="快寫完了"> 
                </div>
            </div>
        </div>

        <div class="right-column" id="colRight">
            <div class="card" id="scheduleCard">
                <div class="card-header">
                    今日考程
                    <button class="btn btn-edit admin-only" onclick="openScheduleEditor()">✎ 編輯</button>
                </div>
                <table id="scheduleTable">
                    <thead><tr><th>時間</th><th>科目</th><th>備註</th></tr></thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card" id="attendanceCard">
        <div class="att-top-row">
            <div class="att-item-container">
                <span class="att-label">應到</span>
                <input type="number" id="shouldVal" class="att-val" value="37" onchange="manualUpdateAttendance()">
                <span class="att-unit">人</span>
            </div>
            <div class="att-item-container">
                <span class="att-label">實到</span>
                <input type="number" id="actualVal" class="att-val" value="37" readonly>
                <span class="att-unit">人</span>
            </div>
        </div>
        
        <div class="att-bottom-row">
            <span class="att-label">缺席座號</span>
            <div class="input-wrapper">
                <input type="text" id="absentVal" class="att-val" placeholder="無" readonly>
                <button class="btn-picker" onclick="openSeatPicker()">選號</button>
            </div>
        </div>
        <div class="signature">大安高工陳吳煜老師製</div>
    </div>

    <div id="editorModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary-color)">編輯考程</h3>
            <div id="editorRows"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn" onclick="addEditorRow()" style="background:#eee;">+ 新增一節</button>
                <button class="btn btn-save" onclick="saveScheduleFromEditor()">儲存</button>
                <button class="btn" onclick="closeEditor()">取消</button>
            </div>
        </div>
    </div>

    <div id="seatModal" class="modal">
        <div class="seat-grid-container">
            <div class="seat-header">點選缺席座號</div>
            <div id="seatGrid" class="seat-grid"></div>
            <div class="seat-footer">
                <button class="btn-clear" onclick="clearAllSeats()">全部清除</button>
                <div>
                    <button class="btn-confirm" onclick="confirmSeats()">確定</button>
                    <button class="btn-cancel" onclick="closeSeatPicker()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQACAdB7m2Bb2uYz7aIHU5TdXo5254vD0lpaKBkkyw621OEPW0hzHMdcFa5isuUDotgbFq7GRFghl9c/pub?output=csv";
        const PASSWORDS = { ADMIN: '1005', STUDENT: '1630' };
        let currentUserRole = null;
        let isForceMode = false;
        
        const DEFAULT_ANNOUNCEMENT = `考試期間請遵守以下規定：
1. 請將手機及智慧型穿戴裝置關機並放置於手機袋。
2. 書包請放置於教室前、後方走道。
3. 桌子請轉向（抽屜朝向講桌）。
4. 桌面僅留下必要的文具用品。
5. 考試期間請勿交談。`;

        const DEFAULT_SCHEDULE = [];

        let appData = {
            schedule: JSON.parse(JSON.stringify(DEFAULT_SCHEDULE)),
            announcement: DEFAULT_ANNOUNCEMENT,
            attendance: { should: 37, actual: 37, absent: "" }
        };

        let tempSelectedSeats = new Set();

        function init() {
            setDocHeight();
            window.addEventListener('resize', setDocHeight);

            if(GOOGLE_SHEET_CSV_URL && GOOGLE_SHEET_CSV_URL.length > 10) {
                fetchGoogleSheetData();
                setInterval(fetchGoogleSheetData, 60000);
            } else {
                loadLocalData();
            }
            
            updateClock();
            setInterval(updateClock, 1000);
            renderUI();
            
            const savedRole = localStorage.getItem('role');
            if(savedRole) authSuccess(savedRole);
        }

        function setDocHeight() {
            document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            document.body.style.height = `calc(var(--vh, 1vh) * 100)`;
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('timeDisplay').textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
            document.getElementById('dateDisplay').textContent = now.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'long' });
            
            if (!isForceMode) checkScheduleMode(now);
            if (currentUserRole === 'student') checkStudentAlerts(now);
            
            renderScheduleColor(now);
        }

        function checkStudentAlerts(now) {
            const overlay = document.getElementById('studentOverlay');
            const msgBox = document.getElementById('overlayMessage');
            let activeAlert = null; 

            // 1. 打掃 (統一用 style-warning)
            if(appData.schedule.length > 0) {
                const lastItem = appData.schedule[appData.schedule.length - 1];
                const [eH, eM] = lastItem.end.split(':').map(Number);
                const endTime = new Date(); endTime.setHours(eH, eM, 0);
                if(now >= endTime && now < new Date(endTime.getTime() + 10*60000)) {
                    activeAlert = { type: 'warning', text: '<h1>請開始進行<br>打掃工作</h1>', blink: false, size: 'h-50' };
                }
            }

            // 2. 預備鐘
            if(!activeAlert) {
                for(let item of appData.schedule) {
                    if(item.subject === '自習' || item.subject === '午休') continue;
                    const [sH, sM] = item.start.split(':').map(Number);
                    const startTime = new Date(); startTime.setHours(sH, sM, 0);
                    const diffSec = (startTime - now) / 1000;

                    if(diffSec > 0 && diffSec <= 180) { 
                        let text = '<h1>即將開始考試<br>請儘速就座！</h1>';
                        let blink = false;
                        let size = 'h-33'; 
                        if(diffSec <= 60) { 
                            blink = true;
                            size = 'h-50';
                        }
                        activeAlert = { type: 'warning', text: text, blink: blink, size: size };
                        break;
                    }
                }
            }

            // 3. 自習提醒
            if(!activeAlert) {
                const nowMinutes = now.getHours() * 60 + now.getMinutes();
                const isSelfStudy = appData.schedule.some(item => {
                    const [sH, sM] = item.start.split(':').map(Number);
                    const [eH, eM] = item.end.split(':').map(Number);
                    const start = sH * 60 + sM;
                    const end = eH * 60 + eM;
                    return (nowMinutes >= start && nowMinutes < end && item.subject.includes('自習'));
                });

                if(isSelfStudy) {
                    const m = now.getMinutes();
                    const s = now.getSeconds();
                    if (m % 10 === 0 && s < 30) {
                        activeAlert = { type: 'warning', text: '<h1>請保持安靜<br>打起精神<br>專心看書！</h1>', blink: false, size: 'h-50' };
                    }
                }
            }

            if(activeAlert) {
                overlay.className = 'active'; 
                msgBox.innerHTML = activeAlert.text;
                // 全部統一使用 style-warning (黃底黑字)
                msgBox.className = `overlay-message style-warning ${activeAlert.size}`;
                if(activeAlert.blink) msgBox.classList.add('blink-effect');
            } else {
                overlay.className = ''; 
            }
        }

        function checkScheduleMode(now) {
            const nowTime = now.getHours() * 60 + now.getMinutes();
            let isExamining = false;
            let currentSubject = "";
            let remainingSec = 0;

            appData.schedule.forEach((item) => {
                const [sH, sM] = item.start.split(':').map(Number);
                const [eH, eM] = item.end.split(':').map(Number);
                const startMin = sH * 60 + sM;
                const endMin = eH * 60 + eM;
                if (nowTime >= startMin && nowTime < endMin) {
                    if (item.subject !== "自習" && item.subject !== "午休") {
                        isExamining = true;
                        currentSubject = item.subject;
                        const endDate = new Date();
                        endDate.setHours(eH, eM, 0);
                        remainingSec = (endDate - now) / 1000;
                    }
                }
            });

            const body = document.body;
            const badge = document.getElementById('currentModeBadge');
            const infoCard = document.getElementById('infoCard');
            const colLeft = document.getElementById('colLeft');
            const colRight = document.getElementById('colRight');
            const scheduleCard = document.getElementById('scheduleCard');

            if (isExamining) {
                if(!body.classList.contains('mode-exam')) {
                    body.classList.remove('mode-study');
                    body.classList.add('mode-exam');
                    
                    // 強制版面調整
                    scheduleCard.style.display = 'none'; // 隱藏考程
                    colRight.appendChild(infoCard); // 公告移到右邊
                    infoCard.style.display = 'flex'; 
                    infoCard.style.height = '100%'; 
                }
                badge.textContent = `考試中：${currentSubject}`;
                handleCountdown(remainingSec);
            } else {
                if(!body.classList.contains('mode-study')) {
                    body.classList.remove('mode-exam');
                    body.classList.add('mode-study');
                    
                    // 強制版面還原
                    colLeft.appendChild(infoCard); // 公告移回左邊
                    scheduleCard.style.display = 'flex'; // 顯示考程
                }
                badge.textContent = "自習/下課時段";
                document.getElementById('countdownArea').style.display = 'none';
                
                const imgContainer = document.getElementById('hurryImageContainer');
                imgContainer.style.display = 'none';
                imgContainer.classList.remove('expanded');
            }
        }

        function handleCountdown(remainingSec) {
            const area = document.getElementById('countdownArea');
            const text = document.getElementById('countdownText');
            const bar = document.getElementById('progressBar');
            const imgContainer = document.getElementById('hurryImageContainer');
            
            if (remainingSec <= 300 && remainingSec > 0) {
                area.style.display = 'block';
                const mins = Math.ceil(remainingSec / 60);
                
                if (currentUserRole === 'student') {
                    if (remainingSec <= 60) {
                        // < 1 min: 滿版
                        imgContainer.style.display = 'flex';
                        imgContainer.classList.add('expanded');
                    } else {
                        // > 1 min: 隱藏 (您說不要從小變大，直接滿版)
                        imgContainer.style.display = 'none';
                        imgContainer.classList.remove('expanded');
                    }
                } else {
                    imgContainer.style.display = 'none'; // 老師端不顯示
                }

                if (mins > 1) {
                    text.textContent = `倒數 ${mins} 分鐘`;
                    text.classList.remove('urgent');
                } else if (remainingSec > 10) {
                    text.textContent = `倒數 1 分鐘`;
                    text.classList.add('urgent');
                } else {
                    text.textContent = `準備交卷`;
                }
                
                const percent = (remainingSec / 300) * 100;
                bar.style.width = `${percent}%`;
            } else {
                area.style.display = 'none';
                imgContainer.style.display = 'none';
                imgContainer.classList.remove('expanded');
            }
        }

        function manualUpdateAttendance() {
            saveData();
            recalcActual();
        }

        function recalcActual() {
            const should = parseInt(document.getElementById('shouldVal').value) || 0;
            const absentStr = document.getElementById('absentVal').value;
            let absentCount = 0;
            if(absentStr && absentStr !== '無') {
                absentCount = absentStr.split(',').length;
            }
            document.getElementById('actualVal').value = should - absentCount;
            appData.attendance.should = document.getElementById('shouldVal').value;
            appData.attendance.actual = document.getElementById('actualVal').value;
            localStorage.setItem('examDashboardData', JSON.stringify(appData));
        }

        function openSeatPicker() {
            const grid = document.getElementById('seatGrid');
            grid.innerHTML = '';
            tempSelectedSeats.clear();
            const currentStr = document.getElementById('absentVal').value;
            if(currentStr && currentStr !== '無') {
                currentStr.split(',').forEach(s => tempSelectedSeats.add(parseInt(s.trim())));
            }
            for(let i=1; i<=50; i++) {
                const btn = document.createElement('div');
                btn.className = 'seat-btn';
                if(tempSelectedSeats.has(i)) btn.classList.add('selected');
                btn.textContent = i < 10 ? '0'+i : i;
                btn.onclick = () => {
                    if(tempSelectedSeats.has(i)) { tempSelectedSeats.delete(i); btn.classList.remove('selected'); } 
                    else { tempSelectedSeats.add(i); btn.classList.add('selected'); }
                };
                grid.appendChild(btn);
            }
            document.getElementById('seatModal').style.display = 'flex';
        }

        function clearAllSeats() {
            tempSelectedSeats.clear();
            document.querySelectorAll('.seat-btn').forEach(btn => btn.classList.remove('selected'));
        }

        function confirmSeats() {
            const sorted = Array.from(tempSelectedSeats).sort((a,b) => a-b);
            const str = sorted.map(n => n < 10 ? '0'+n : n).join(', ');
            document.getElementById('absentVal').value = str || '';
            recalcActual();
            closeSeatPicker();
        }

        function closeSeatPicker() {
            document.getElementById('seatModal').style.display = 'none';
        }

        function login() {
            const val = document.getElementById('passInput').value;
            if (val === PASSWORDS.ADMIN) authSuccess('admin');
            else if (val === PASSWORDS.STUDENT) authSuccess('student');
            else { alert("驗證碼錯誤"); document.getElementById('passInput').value = ""; }
        }

        function authSuccess(role) {
            currentUserRole = role;
            localStorage.setItem('role', role);
            document.getElementById('loginOverlay').classList.add('hidden');
            document.body.classList.remove('role-admin', 'role-student');
            document.body.classList.add(`role-${role}`);
        }

        function logout() { localStorage.removeItem('role'); location.reload(); }
        
        function toggleForceMode() {
            isForceMode = !isForceMode;
            if(document.body.classList.contains('mode-exam')) {
                document.body.classList.remove('mode-exam'); 
                body.classList.add('mode-study');
                checkScheduleMode(new Date()); // 強制刷新版面
            } else {
                document.body.classList.remove('mode-study'); 
                document.body.classList.add('mode-exam');
                checkScheduleMode(new Date()); // 強制刷新版面
            }
            document.getElementById('currentModeBadge').textContent = isForceMode ? "手動模式" : "自動模式";
        }

        function renderUI() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            appData.schedule.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.start}-${item.end}</td><td>${item.subject}</td><td>${item.note}</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('announcementContent').textContent = appData.announcement;
            document.getElementById('shouldVal').value = appData.attendance.should;
            document.getElementById('actualVal').value = appData.attendance.actual;
            document.getElementById('absentVal').value = appData.attendance.absent;
        }

        function editInfo() {
            const newText = prompt("編輯公告內容", appData.announcement);
            if(newText !== null) { appData.announcement = newText; saveData(); renderUI(); }
        }
        function openScheduleEditor() {
            const container = document.getElementById('editorRows');
            container.innerHTML = '';
            appData.schedule.forEach(item => addEditorRow(item));
            document.getElementById('editorModal').style.display = 'flex';
        }
        function addEditorRow(data = {start:'', end:'', subject:'', note:''}) {
            const div = document.createElement('div');
            div.className = 'edit-row';
            div.innerHTML = `
                <input type="time" class="e-start" value="${data.start}">
                <input type="time" class="e-end" value="${data.end}">
                <input type="text" class="e-sub" placeholder="科目" value="${data.subject}">
                <input type="text" class="e-note" placeholder="備註" value="${data.note}">
                <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none;">✖</button>
            `;
            document.getElementById('editorRows').appendChild(div);
        }
        function saveScheduleFromEditor() {
            const rows = document.querySelectorAll('.edit-row');
            const newSchedule = [];
            rows.forEach(row => {
                const start = row.querySelector('.e-start').value;
                const end = row.querySelector('.e-end').value;
                const subject = row.querySelector('.e-sub').value;
                const note = row.querySelector('.e-note').value;
                if(start && end && subject) newSchedule.push({ start, end, subject, note });
            });
            newSchedule.sort((a, b) => a.start.localeCompare(b.start));
            appData.schedule = newSchedule;
            saveData();
            renderUI();
            closeEditor();
        }
        function closeEditor() { document.getElementById('editorModal').style.display = 'none'; }
        
        function saveData() {
            appData.attendance.should = document.getElementById('shouldVal').value;
            appData.attendance.actual = document.getElementById('actualVal').value;
            appData.attendance.absent = document.getElementById('absentVal').value;
            localStorage.setItem('examDashboardData', JSON.stringify(appData));
        }
        
        function loadLocalData() {
            const saved = localStorage.getItem('examDashboardData');
            if(saved) {
                const parsed = JSON.parse(saved);
                appData.attendance = parsed.attendance;
                if(appData.schedule.length === 0) {
                    appData.schedule = parsed.schedule;
                    appData.announcement = parsed.announcement;
                }
            }
        }

        // [核心修正] 強力公告解析：抓取標題列之前的所有內容
        function fetchGoogleSheetData() {
            const urlWithNoCache = GOOGLE_SHEET_CSV_URL + "&t=" + Date.now();
            const statusLight = document.getElementById('syncStatus');
            fetch(urlWithNoCache, {cache: "no-store"})
            .then(response => response.text())
            .then(csvText => {
                if (document.getElementById('seatModal').style.display === 'flex' || document.activeElement.tagName === 'INPUT') return;

                const rows = csvText.split('\n').map(row => row.split(','));
                if(rows.length > 2) {
                    statusLight.classList.add('active'); 
                    setTimeout(() => statusLight.classList.remove('active'), 1000);

                    // 1. 抓考程標題列位置
                    let headerIndex = -1;
                    for(let i=0; i<rows.length; i++) {
                        const rowStr = rows[i].join('').toLowerCase();
                        if(rowStr.includes('start') && rowStr.includes('subject')) {
                            headerIndex = i; break;
                        }
                    }
                    
                    // 2. 抓公告 (Header 之前的所有列)
                    let announcementLines = [];
                    const limit = (headerIndex !== -1) ? headerIndex : 1;
                    
                    for(let i=0; i<limit; i++) {
                        // 移除 CSV 格式的引號，並處理手動輸入的 \n 字串
                        let line = rows[i][0]
                            .replace(/^"|"$/g, '')
                            .replace(/""/g, '"')
                            .replace(/\\n/g, '\n'); // [修正] 將 \n 字串轉為換行符號
                        
                        if(line.trim() !== "") announcementLines.push(line);
                    }
                    if(announcementLines.length > 0) {
                        appData.announcement = announcementLines.join('\n');
                    }

                    // 3. 抓考程
                    const startIndex = (headerIndex !== -1) ? headerIndex + 1 : 2;
                    const newSchedule = [];
                    for(let i=startIndex; i<rows.length; i++) {
                        const row = rows[i];
                        let date = "", start, end, subject, note;
                        if(row[0].includes('20')) { 
                            date = row[0].trim();
                            start = row[1]; end = row[2]; subject = row[3]; note = row[4];
                        } else { 
                            start = row[0]; end = row[1]; subject = row[2]; note = row[3];
                        }

                        if(start && end && subject) {
                            newSchedule.push({
                                date: date,
                                start: start.trim().replace(/"/g,''),
                                end: end.trim().replace(/"/g,''),
                                subject: subject.trim().replace(/"/g,''),
                                note: note ? note.trim().replace(/"/g,'') : ""
                            });
                        }
                    }

                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    const todayStr = `${yyyy}/${mm}/${dd}`;

                    let todaySchedules = newSchedule.filter(s => s.date === todayStr);
                    
                    if(todaySchedules.length > 0) {
                        appData.schedule = todaySchedules;
                    } else {
                        if(newSchedule.length > 0) {
                            const firstDate = newSchedule[0].date;
                            appData.schedule = newSchedule.filter(s => s.date === firstDate);
                        } else {
                            appData.schedule = [];
                        }
                    }
                    
                    renderUI();
                }
            })
            .catch(err => console.error("同步失敗:", err));
        }

        function renderScheduleColor(now) {
            const rows = document.querySelectorAll('#scheduleBody tr');
            const nowTime = now.getHours() * 60 + now.getMinutes();
            appData.schedule.forEach((item, index) => {
                if(!rows[index]) return;
                const [eH, eM] = item.end.split(':').map(Number);
                const [sH, sM] = item.start.split(':').map(Number);
                const endMin = eH * 60 + eM;
                const startMin = sH * 60 + sM;
                rows[index].className = ''; 
                if (nowTime >= endMin) rows[index].classList.add('past-row'); 
                else if (nowTime >= startMin && nowTime < endMin) rows[index].classList.add('current-row');
            });
        }

        init();
    </script>
</body>
</html>
